<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MECANGOï½œæ­£å¼å ±åƒ¹å–®ï¼ˆv6.8 åœ–ç‰‡åŒ¯å‡ºç‰ˆï¼‰</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* --- å…¨å±€è®Šæ•¸ (V6.4 ç¶“å…¸æ·±è—é‡‘é…è‰²) --- */
:root{
  --deep: #0A1221;       /* ç¶²é èƒŒæ™¯ */
  --card: #0C152A;       /*å€å¡ŠèƒŒæ™¯ */
  --gold: #C9A227;       /* é‡‘è‰²ä¸»è‰² */
  --gold-soft: #E9D18A;  /* æŸ”å’Œé‡‘ */
  --ink: #e7ecf3;        /* ä¸»æ–‡å­— */
  --muted: #9aa4b2;      /* æ¬¡è¦æ–‡å­— */
  --line: rgba(233,209,138,.28); /* é‡‘è‰²ç´°ç·š */
  --input-bg: #071226;   /* è¼¸å…¥æ¡†èƒŒæ™¯ */
  --danger: #ff4d4f;     /* åˆªé™¤ç´… */
}

*{box-sizing:border-box}
html,body{margin:0;background:var(--deep);color:var(--ink);font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif;line-height:1.5}
.wrap{max-width:1100px;margin:0 auto;padding:16px}

/* --- UI ä»‹é¢æ¨£å¼ --- */
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0C152A,#0A1221);margin-bottom:12px}
.brand{display:flex;gap:12px;align-items:center}
.brand img{width:56px;height:56px;object-fit:contain;border-radius:12px;border:1px solid var(--line);background:#0b1430}
.brand .meta{display:grid;gap:4px}
.brand .meta .corp{font-weight:800;font-size:18px;letter-spacing:.5px}
.brand .meta .sub{font-size:12px;color:var(--muted)}

.block{border:1px solid var(--line);border-radius:14px;padding:16px;background:var(--card);margin-bottom:12px}
.h{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;border-bottom:1px dashed var(--line);padding-bottom:8px}
.h .t{font-weight:800;color:var(--ink)}
.h .t em{font-style:normal;color:var(--gold-soft);margin-left:6px;font-size:0.9em}
.h small{color:var(--muted)}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}

.row{display:grid;grid-template-columns:90px 1fr;gap:8px;align-items:center}
.row label{color:var(--muted);font-size:14px;text-align:right}
.row input,.row select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--input-bg);color:var(--ink);font-size:15px}
.row input:focus,.row select:focus{border-color:var(--gold);outline:none;box-shadow: 0 0 0 1px var(--gold);}

.btns{display:flex;gap:8px;flex-wrap:wrap;}
.btn{border:1px solid var(--line);background:transparent;color:var(--ink);padding:8px 16px;border-radius:12px;cursor:pointer;font-size:14px;transition:0.2s;display:flex;align-items:center;gap:6px;}
.btn:hover{background:rgba(255,255,255,0.05);border-color:var(--gold-soft);}
.btn.primary{background:var(--gold);color:#000;border-color:var(--gold);font-weight:bold;}
.btn.primary:hover{opacity:0.9;}
.btn[style*="color:var(--danger)"] { border-color: rgba(255, 77, 79, 0.3); color: var(--danger); }
.btn[style*="color:var(--danger)"]:hover { background: rgba(255, 77, 79, 0.1); border-color: var(--danger); }

/* é è¦½è¡¨æ ¼ */
.preview-table{width:100%;border-collapse:collapse;font-size:14px}
.preview-table thead{background:#0e1830;}
.preview-table th{text-align:left;padding:10px;color:var(--gold-soft);border-bottom:1px solid var(--line);font-size:13px}
.preview-table td{padding:10px;border-bottom:1px solid rgba(233,209,138,0.1)}
.preview-table .num{text-align:right;font-family:Consolas, monospace}
.preview-foot{display:flex;flex-direction:column;align-items:flex-end;gap:4px;margin-top:12px;padding-top:12px;border-top:1px dashed var(--line)}
.preview-foot div{display:flex;gap:20px;font-size:14px;color:var(--muted)}
.preview-foot .total{color:var(--gold);font-size:18px;font-weight:bold;color:var(--gold)}

/* é…ç½®å€å¡Š */
.config-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:768px){.config-grid{grid-template-columns:1fr}}

.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.flex input[type="checkbox"]{width:20px;height:20px;appearance:none;border:1px solid var(--line);border-radius:4px;background:var(--input-bg);cursor:pointer;position:relative;top:1px;}
.flex input[type="checkbox"]:checked{background:var(--gold);border-color:var(--gold);}
.flex input[type="checkbox"]:checked::after{content:'âœ”';color:#000;font-size:14px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);}
.flex small{color:var(--muted)}

/* æ‰‹å‹•é‡‘é¡è¼¸å…¥æ¡† */
.manual-price{display:none;width:110px;padding:8px;border-radius:8px;border:1px solid var(--line);background:var(--input-bg);color:var(--gold);text-align:right;font-family:Consolas,monospace;}
.manual-price::placeholder{color:var(--muted);font-size:12px;font-family:sans-serif;}

.rm{color:var(--danger);cursor:pointer;padding:4px 8px;border:1px solid rgba(255,77,79,0.3);border-radius:8px;background:rgba(255,77,79,0.1);font-size:13px}
.rm:hover{background:var(--danger);color:#fff}
.add-btn{width:100%;padding:10px;border:1px dashed var(--line);background:rgba(12, 21, 42, 0.5);color:var(--muted);cursor:pointer;border-radius:12px;margin-top:8px;transition:0.2s}
.add-btn:hover{border-color:var(--gold);color:var(--gold);background:rgba(201, 162, 39, 0.1);}

/* --- æ­£å¼å ±åƒ¹å–®æ¨£å¼ (é€šç”¨æ–¼åˆ—å°èˆ‡ PNG åŒ¯å‡º) --- */
#print-layout { 
  display: none; /* é è¨­éš±è—ï¼Œé»åŒ¯å‡ºæ™‚æœƒçŸ­æš«é¡¯ç¤º */
  width: 100%;
  max-width: 800px; /* é™åˆ¶å¯¬åº¦è®“åœ–ç‰‡æ¯”ä¾‹å¥½çœ‹ */
  background: #fff;
  color: #000;
  padding: 20px;
  font-family: "Microsoft JhengHei", Arial, sans-serif;
}

.print-title { text-align: center; font-size: 24px; font-weight: 900; margin-bottom: 20px; letter-spacing: 2px; color: #000; }

/* å®¢æˆ¶è³‡è¨Šè¡¨æ ¼ */
.info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
.info-table th, .info-table td { border: 1px solid #999; padding: 8px; color: #000; }
.info-table th { background-color: #f0f0f0 !important; width: 15%; text-align: center; font-weight: bold; }
.info-table td { width: 35%; }

/* ä¸»å ±åƒ¹è¡¨æ ¼ */
.main-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.main-table th { background-color: #e6e6e6 !important; border: 1px solid #999; padding: 10px 6px; text-align: center; font-weight: bold; color: #000; }
.main-table td { border: 1px solid #ccc; padding: 8px 6px; vertical-align: middle; color: #000; }
.main-table .col-name { text-align: left; }
.main-table .col-num { text-align: right; }
.main-table .col-center { text-align: center; }

/* Footer Totals */
.footer-table { width: 100%; border-collapse: collapse; margin-top: 0; }
.footer-table td { padding: 8px 6px; text-align: right; font-size: 13px; border-right: 1px solid #ccc; color: #000; }
.ft-row td { border-bottom: 1px solid #ccc; }
.ft-total td { border-bottom: 2px solid #000; font-weight: 900; font-size: 15px; background-color: #fcfcfc; }
.label-col { width: 80%; font-weight: bold; }
.val-col { width: 20%; }

/* åŒ¯æ¬¾è³‡è¨Šå€å¡Š (Excel Friendly) */
.bank-box { width:100%; margin-top: 20px; border: 1px solid #000; color: #000; }
.bank-box td { padding: 10px; font-size: 12px; line-height: 1.6; vertical-align: top; }
.bank-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; }

@media print {
  @page { size: A4; margin: 10mm; }
  body { background: #fff; color: #000; -webkit-print-color-adjust: exact; }
  .wrap { display: none; }
  #print-layout { display: block; width: 100%; max-width: none; padding: 0; }
  .bank-box { page-break-inside: avoid; }
}
</style>
</head>
<body>

<div class="wrap">
  <div class="header">
    <div class="brand">
      <img src="https://crmpos.mecango.com/_files/49/9040149/f/eae0f725de036939.png">
      <div class="meta">
        <div class="corp">å±¹ç™»è‚¡ä»½æœ‰é™å…¬å¸</div>
        <div class="sub">çµ±ç·¨ï¼š90693783</div>
      </div>
    </div>
    <div class="btns">
      <button class="btn primary" onclick="exportPNG()">ğŸ“· åŒ¯å‡ºåœ–ç‰‡ (PNG)</button>
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / PDF</button>
      <button class="btn" onclick="copyExcelHTML()">ğŸ“‹ è¤‡è£½è¡¨æ ¼ (Excel)</button>
      <button class="btn" onclick="clearData()" style="color:var(--danger);border-color:var(--danger)">âœ• é‡å¡«</button>
    </div>
  </div>

  <div class="block">
    <div class="h"><div class="t">å®¢æˆ¶è³‡è¨Š <em>Client Info</em></div></div>
    <div class="grid2">
      <div class="row"><label>å ±åƒ¹æ—¥æœŸ</label><input id="in_date" type="date" oninput="render()"></div>
      <div class="row"><label>å…¬å¸æŠ¬é ­</label><input id="in_corp" placeholder="å®¢æˆ¶åç¨±" oninput="render()"></div>
      <div class="row"><label>è¯çµ¡äºº</label><input id="in_contact" placeholder="å§“å" oninput="render()"></div>
      <div class="row"><label>çµ±ä¸€ç·¨è™Ÿ</label><input id="in_tax" placeholder="8ç¢¼çµ±ç·¨" oninput="render()"></div>
      <div class="row"><label>é›»è©±</label><input id="in_tel" placeholder="è¯çµ¡é›»è©±" oninput="render()"></div>
      <div class="row"><label>Email</label><input id="in_email" placeholder="ä¿¡ç®±" oninput="render()"></div>
      <div class="row"><label>åœ°å€</label><input id="in_addr" placeholder="å…¬å¸åœ°å€" oninput="render()"></div>
      <div class="row"><label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="in_pay" onchange="render()">
          <option>åŒ¯æ¬¾</option><option>ç¾é‡‘</option><option>åˆ·å¡(5%)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="block">
    <div class="h"><div class="t">å ±åƒ¹é è¦½ <em>Quote Preview</em></div><small>æ­¤è™•åƒ…ä¾›é è¦½ï¼Œåˆ—å°æ ¼å¼æœƒä¸åŒ</small></div>
    <table class="preview-table">
      <thead><tr><th>é …ç›®</th><th class="num">å¹´è²»</th><th class="num">æ•¸é‡</th><th class="num">å°è¨ˆ</th></tr></thead>
      <tbody id="ui_tbody"></tbody>
    </table>
    <div class="preview-foot">
      <div><span>å°è¨ˆ(æœªç¨…)</span><span id="ui_sub">0</span></div>
      <div><span>ç¨…é¡(5%)</span><span id="ui_tax">0</span></div>
      <div class="total"><span>ç¸½è¨ˆ</span><span id="ui_total">0</span></div>
    </div>
  </div>

  <div class="config-grid">
    <div class="block">
      <div class="h"><div class="t">ç³»çµ±å¹³å° <em>Platform</em></div></div>
      <div class="flex">
        <input type="checkbox" id="setup_chk" checked onchange="render()"> <small>å»ºç½®è²»</small>
        <select id="setup_sel" style="flex:1" onchange="render()"></select>
      </div>
      <div class="flex" style="margin-top:10px">
        <small>ç©ºé–“</small>
        <select id="space_sel" style="flex:1" onchange="render()"></select>
      </div>
      <div class="flex" style="margin-top:10px">
        <small>SSLæ†‘è­‰</small>
        <select id="ssl_sel" style="width:60px" onchange="render()"></select> çµ„
      </div>
    </div>
    <div class="block">
      <div class="h"><div class="t">é›²ç«¯è³‡æ–™åº« <em>Cloud DB</em></div></div>
      <div id="cloud_list"></div>
      <button class="add-btn" onclick="addCloudRow()">+ æ–°å¢é›²ç«¯æ–¹æ¡ˆ</button>
    </div>
    <div class="block">
      <div class="h"><div class="t">åŠ å€¼æœå‹™ <em>Add-ons</em></div></div>
      <div id="addon_list"></div>
      <button class="add-btn" onclick="addAddonRow()">+ æ–°å¢åŠ å€¼æœå‹™</button>
    </div>
    <div class="block">
      <div class="h"><div class="t">ç¡¬é«”è¨­å‚™ <em>Hardware</em></div></div>
      <div id="device_list"></div>
      <button class="add-btn" onclick="addDeviceRow()">+ æ–°å¢ç¡¬é«”è¨­å‚™</button>
    </div>
  </div>
</div>

<div id="print-layout">
  <div class="print-title">æ­£å¼å ±åƒ¹å–®</div>
  
  <table class="info-table">
    <tr>
      <th>å ±åƒ¹æ—¥æœŸ</th><td id="p_date"></td>
      <th>å…¬å¸æŠ¬é ­</th><td id="p_corp"></td>
    </tr>
    <tr>
      <th>è¯çµ¡äºº</th><td id="p_contact"></td>
      <th>çµ±ä¸€ç·¨è™Ÿ</th><td id="p_tax_id"></td>
    </tr>
    <tr>
      <th>é›»è©±</th><td id="p_tel"></td>
      <th>Email</th><td id="p_email"></td>
    </tr>
    <tr>
      <th>å…¬å¸åœ°å€</th><td colspan="3" id="p_addr"></td>
    </tr>
    <tr>
      <th>ä»˜æ¬¾æ–¹å¼</th><td colspan="3" id="p_pay"></td>
    </tr>
  </table>

  <table class="main-table">
    <thead>
      <tr>
        <th width="30%">é …ç›®åç¨±</th>
        <th width="14%">å–®æ¬¡è²»ç”¨</th>
        <th width="14%">æœˆè²»</th>
        <th width="14%">å¹´è²»</th>
        <th width="10%">æ•¸é‡/å¥—æ•¸</th>
        <th width="18%">å°è¨ˆ (æœªç¨…)</th>
      </tr>
    </thead>
    <tbody id="p_tbody">
      </tbody>
  </table>

  <table class="footer-table">
    <tr class="ft-row">
      <td class="label-col">å°è¨ˆ Amount (æœªç¨…)</td>
      <td class="val-col" id="p_sub">0</td>
    </tr>
    <tr class="ft-row">
      <td class="label-col">ç¨…é¡ Tax (5%)</td>
      <td class="val-col" id="p_calc_tax">0</td>
    </tr>
    <tr class="ft-total">
      <td class="label-col">ç¸½è¨ˆ Total (å«ç¨…)</td>
      <td class="val-col" id="p_total">0</td>
    </tr>
  </table>

  <table class="bank-box">
    <tr>
      <td>
        <div class="bank-title">ã€åŒ¯æ¬¾è³‡è¨Šã€‘å±¹ç™»è‚¡ä»½æœ‰é™å…¬å¸</div>
        åŒ¯æ¬¾å¸³è™Ÿï¼š042-018-1003-8503<br>
        åˆ†è¡Œï¼š807 æ°¸è±éŠ€è¡Œ åŒ—é«˜é›„åˆ†è¡Œ<br>
        <div style="color:red; margin-top:6px; font-weight:bold">ç‚ºé¿å…å½±éŸ¿æ‚¨çš„æ¬Šç›Šï¼Œè«‹å‹™å¿…å°‡åŒ¯æ¬¾è­‰æ˜å‚³çœŸè‡³æœ¬å…¬å¸ 07-345-4249 ä¸¦è¨»æ˜å…¬å¸åç¨±ã€‚</div>
        <div style="margin-top:4px">æ”¯ç¥¨éƒµå¯„åœ°å€ï¼š807 é«˜é›„å¸‚å·¦ç‡Ÿå€å­Ÿå­è·¯37è™Ÿ3æ¨“ å®¢æœéƒ¨ æ”¶</div>
      </td>
    </tr>
  </table>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const fmt = (n)=>n.toLocaleString('zh-TW');
const num = (v)=>parseFloat(String(v).replace(/[^\d.-]/g,''))||0;

// è³‡æ–™å®šç¾©
const DATA = {
  setup: [
    {t:"CRM å»ºç½®è²»",p:15000}, {t:"é¤é£²POS å»ºç½®è²»",p:18000}, {t:"ç¾æ¥­POS å»ºç½®è²»",p:20000},
    {t:"CRM é›»å•†å»ºç½®",p:25000}, {t:"å½±éŸ³é–‹èª²å»ºç½®è²»",p:35000}
  ],
  space: [
    {t:"50G/1è¬äºº ($0)",m:0}, {t:"100G/2è¬äºº ($500)",m:500},
    {t:"100G/5è¬äºº ($1000)",m:1000}, {t:"200G/10è¬äºº ($1500)",m:1500}
  ],
  cloud: [
    {t:"CRM(å–®åº—)ï¼å¾®åº—ç‰ˆ",m:3000}, {t:"CRM(å–®åº—)ï¼å°ˆæ¥­ç‰ˆ",m:4000}, {t:"CRM(å–®åº—)ï¼è£‚è®Šç‰ˆ",m:5000},
    {t:"CRM+POSï¼å°è³‡ç‰ˆ",m:3600}, {t:"CRM+POSï¼æ”¤å•†ç‰ˆ",m:4600}, {t:"CRM+POSï¼é–€åº—ç‰ˆ",m:5600}, {t:"å½±éŸ³é–‹èª²(500G)",m:5500},
    {t:"ç¸½åº—ç³»çµ±",y:60000}, {t:"å­åº—ç³»çµ±", manual:true}, {t:"é›»å•†å¹³å°",y:18000}
  ],
  addon: [
    {t:"è¨‚ä½/é ç´„ç³»çµ±",y:15000}, {t:"å¤šå…ƒæ”¯ä»˜",y:5000}, {t:"å¤šåº—æ ¸éŠ·",m:1000},
    {t:"é›»å­ç™¼ç¥¨(è—æ–°)",o:3500}, {t:"è¯ç›Ÿè¡ŒéŠ·",y:12000}, {t:"å¾®å•†æ¨¡çµ„",y:24000}, {t:"APIä¸²æ¥",y:4200}
  ],
  device: [
    {t:"Wifi+USBå‡ºå–®æ©Ÿ(80mm)",o:5500}, {t:"Wifi+USBå‡ºå–®+ç™¼ç¥¨æ©Ÿ(58mm)",o:8500}, {t:"æ¨™ç±¤è²¼ç´™æ©Ÿ",o:6500}, {t:"äºŒç¶­æ¢ç¢¼å™¨",o:1800}, {t:"é›»å­éŒ¢æ«ƒ",o:1980},
    {t:"å‡ºå–®ç´™(80*80)",o:1800}, {t:"ç™¼ç¥¨ç´™",o:1980}, {t:"æ¨™ç±¤ç´™(100å·)",o:2700}
  ]
};

// åˆå§‹åŒ–
function init(){
  $("#in_date").value = new Date().toISOString().slice(0,10);
  DATA.setup.forEach(x=> $("#setup_sel").add(new Option(`${x.t} ($${fmt(x.p)})`, `${x.t}|${x.p}`)));
  DATA.space.forEach(x=> $("#space_sel").add(new Option(x.t, `${x.t}|${x.m}`)));
  for(let i=1;i<=20;i++) $("#ssl_sel").add(new Option(i,i));
  addCloudRow(); 
  render();
}

function getOpts(key){
  return DATA[key].map(x=>{
    let val="", label=x.t;
    if(x.manual) { val=`man|0`; label+=` (æ‰‹å‹•è¼¸å…¥)`; }
    else if(x.o) { val=`o|${x.o}`; label+=` ($${fmt(x.o)}/æ¬¡)`; }
    else if(x.m) { val=`m|${x.m}`; label+=` ($${fmt(x.m)}/æœˆ)`; }
    else { val=`y|${x.y}`; label+=` ($${fmt(x.y)}/å¹´)`; }
    return `<option value="${val}|${x.t}">${label}</option>`;
  }).join('');
}

function addRow(containerId, type){
  const div = document.createElement('div');
  div.className = 'flex';
  div.style.marginBottom = '8px';
  div.innerHTML = `
    <select class="${type}-sel" style="flex:1" onchange="render()">${getOpts(type)}</select>
    <input class="manual-price" placeholder="è¼¸å…¥å¹´è²»" oninput="render()">
    <select class="qty" style="width:60px;text-align:center" onchange="render()">
      ${[...Array(20).keys()].map(i=>`<option ${i===0?'selected':''}>${i+1}</option>`).join('')}
    </select>
    <div class="rm" onclick="this.parentElement.remove();render()">âœ•</div>
  `;
  $(`#${containerId}`).appendChild(div);
  render();
}
function addCloudRow(){ addRow('cloud_list','cloud'); }
function addAddonRow(){ addRow('addon_list','addon'); }
function addDeviceRow(){ addRow('device_list','device'); }

function render(){
  // 1. åŒæ­¥è³‡è¨Š
  $("#p_date").textContent = $("#in_date").value;
  $("#p_corp").textContent = $("#in_corp").value;
  $("#p_contact").textContent = $("#in_contact").value;
  $("#p_tax_id").textContent = $("#in_tax").value; 
  $("#p_tel").textContent = $("#in_tel").value;
  $("#p_email").textContent = $("#in_email").value;
  $("#p_addr").textContent = $("#in_addr").value;
  $("#p_pay").textContent = $("#in_pay").value;

  // 2. è¨ˆç®—
  let subtotal = 0;
  let ui_html = "";
  let p_html = "";

  function push(name, once, mon, year, qty, total){
    subtotal += total;
    ui_html += `<tr><td>${name}</td><td class="num">${year?fmt(year):'-'}</td><td class="num">${qty}</td><td class="num">${fmt(total)}</td></tr>`;
    p_html += `
      <tr>
        <td class="col-name">${name}</td>
        <td class="col-num">${once ? fmt(once) : '-'}</td>
        <td class="col-num">${mon ? fmt(mon) : '-'}</td>
        <td class="col-num">${year ? fmt(year) : '-'}</td>
        <td class="col-center">${qty}</td>
        <td class="col-num">${fmt(total)}</td>
      </tr>
    `;
  }

  if($("#setup_chk").checked){
    const [n,p] = $("#setup_sel").value.split('|');
    push(n, num(p), 0, 0, 1, num(p));
  }
  const [sn, sm] = $("#space_sel").value.split('|');
  if(num(sm)>0) push(`é›²ç«¯ç©ºé–“ (${sn.split(' ')[0]})`, 0, sm, num(sm)*12, 1, num(sm)*12);
  
  const sslq = num($("#ssl_sel").value);
  if(sslq>0) push("SSL å®‰å…¨æ†‘è­‰", 0, Math.round(2000/12), 2000, sslq, sslq*2000);

  const processRows = (selClass) => {
    document.querySelectorAll(selClass).forEach(el => {
      const [mode, price, name] = el.value.split('|');
      const qty = num(el.parentElement.querySelector('.qty').value);
      
      const row = el.parentElement;
      const input = row.querySelector('.manual-price');
      let p = num(price);
      
      if(mode === 'man'){
         input.style.display = 'block';
         p = num(input.value);
      } else {
         input.style.display = 'none';
      }

      let o=0, m=0, y=0, t=0;
      if(mode==='o'){ o=p; t=p*qty; }
      else if(mode==='m'){ m=p; y=p*12; t=y*qty; }
      else if(mode==='y' || mode==='man'){ y=p; m=Math.round(p/12); t=y*qty; }
      
      push(name, o, m, y, qty, t);
    });
  };
  processRows('.cloud-sel');
  processRows('.addon-sel');
  processRows('.device-sel');

  $("#ui_tbody").innerHTML = ui_html;
  $("#p_tbody").innerHTML = p_html;

  const tax = Math.round(subtotal * 0.05);
  const total = subtotal + tax;

  $("#ui_sub").textContent = fmt(subtotal);
  $("#ui_tax").textContent = fmt(tax);
  $("#ui_total").textContent = fmt(total);
  
  $("#p_sub").textContent = fmt(subtotal);
  $("#p_calc_tax").textContent = fmt(tax); 
  $("#p_total").textContent = fmt(total);
}

// åœ–ç‰‡åŒ¯å‡ºé‚è¼¯
function exportPNG() {
  render(); // ç¢ºä¿è³‡æ–™æœ€æ–°
  const element = document.getElementById('print-layout');
  
  // 1. æš«æ™‚é¡¯ç¤ºå…ƒç´ åœ¨ç•«é¢ä¸Šæ–¹(ä¸æœƒæ“‹åˆ°å¤ªå¤šï¼Œé‡é»æ˜¯ä¸èƒ½ display:none)
  element.style.display = 'block';
  element.style.position = 'absolute';
  element.style.left = '-9999px'; // ç§»å‡ºç•«é¢å¤–é¿å…é–ƒçˆ
  element.style.top = '0';

  // 2. åŸ·è¡Œæˆªåœ–
  html2canvas(element, { scale: 2 }).then(canvas => {
    // 3. å¾©åŸæ¨£å¼
    element.style.display = 'none';
    
    // 4. ä¸‹è¼‰åœ–ç‰‡
    const link = document.createElement('a');
    const name = $("#in_corp").value || "MECANGO_å ±åƒ¹å–®";
    link.download = `${name}_${$("#in_date").value}.png`;
    link.href = canvas.toDataURL();
    link.click();
  });
}

function copyExcelHTML() {
  render();
  const printContent = document.getElementById('print-layout').innerHTML;
  const html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head><meta charset="utf-8"></head>
    <body>${printContent}</body></html>
  `;
  const blob = new Blob([html], {type: 'text/html'});
  const item = new ClipboardItem({'text/html': blob});
  navigator.clipboard.write([item]).then(()=>{
    alert("å·²è¤‡è£½ï¼\nè«‹æ‰“é–‹ Excel æˆ– Google Sheet ç›´æ¥è²¼ä¸Š (Ctrl+V)ã€‚");
  }).catch(err=>{
    alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•åˆ—å°æˆ PDFã€‚");
  });
}

function clearData(){
  if(confirm("é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ")) location.reload();
}

init();
</script>
</body>
</html>
