<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MECANGOï½œæ‹“å®¢CRM/POS/é›»å•† æ­£å¼å ±åƒ¹å–®ï¼ˆv4ï¼‰</title>
<style>
:root{
  --deep:#0A1221; --gold:#C9A227; --gold-soft:#E9D18A;
  --card:#0C152A; --ink:#e7ecf3; --muted:#9aa4b2; --line:rgba(233,209,138,.28);
  --accent:#1f2b4a; --ink-2:#cfd6e3;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--deep);color:var(--ink);font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif;line-height:1.5}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0C152A,#0A1221)}
.brand{display:flex;gap:12px;align-items:center}
.brand img{width:56px;height:56px;object-fit:contain;border-radius:12px;border:1px solid var(--line);background:#0b1430}
.brand .meta{display:grid;gap:4px}
.brand .meta .corp{font-weight:800;font-size:18px;letter-spacing:.5px}
.brand .meta .sub{font-size:12px;color:var(--ink-2)}
.block{border:1px solid var(--line);border-radius:14px;padding:12px;background:var(--card);margin-top:12px}
.h{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.h .t{font-weight:800}
.h .t em{font-style:normal;color:var(--gold-soft)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
.row{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
.row label{color:var(--muted);font-size:14px}
.row input,.row select,.row textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--line);background:#071226;color:var(--ink);font-size:15px}
textarea{min-height:72px;resize:vertical}
.small{font-size:12px;color:var(--muted)}
.badge{font-size:12px;color:#111;background:var(--gold-soft);padding:6px 10px;border-radius:999px}
.badge2{font-size:12px;color:#111;background:var(--gold);padding:4px 8px;border-radius:6px}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--line);background:transparent;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-size:15px}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold)}
.kv{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:900px){.kv{grid-template-columns:1fr}}
.kv .box{border:1px dashed var(--line);border-radius:12px;padding:10px}
.kv .box .lab{font-size:12px;color:var(--muted)}
.kv .box .val{font-weight:700;font-size:16px}

.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{padding:10px;border-bottom:1px dashed var(--line);text-align:left}
.table th{position:sticky;top:0;background:linear-gradient(0deg,#0c152a,#0e1830)}
.table .num{text-align:right;white-space:nowrap}

.summary{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.summary table{width:100%;border-collapse:collapse}
.summary th,.summary td{padding:12px;border-bottom:1px solid var(--line)}
.summary thead th{background:#0e1830}
.summary tfoot td{font-weight:700}

.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.line{border-top:1px dashed var(--line);margin:10px 0}
.rm{cursor:pointer;border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#0a152a}
.manualBox{display:none;gap:6px;align-items:center}
.manualBox input{width:120px;text-align:right}

.totalgrid{display:grid;grid-template-columns:1fr 220px;gap:12px;align-items:flex-start}
.totalbox{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1630}
.totalbox .row2{display:flex;justify-content:space-between;margin:6px 0}
.totalbox .row2 strong{font-size:18px}
.termblock{border:1px dashed var(--line);border-radius:12px;padding:10px}

.stickybar{position:sticky;bottom:8px;left:0;right:0;margin-top:12px;display:flex;gap:8px;justify-content:space-between;align-items:center;background:rgba(12,21,42,.9);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:12px;padding:8px 12px}
.stickybar .fig{font-weight:800;font-size:18px}

@media print{
  .stickybar,.btns{display:none}
  .wrap{max-width:100%;padding:0}
  .header,.block{page-break-inside:avoid}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- å…¬å¸æŠ¬é ­ / å ±åƒ¹å–®è³‡è¨Š -->
  <div class="header">
    <div class="brand">
      <img id="logo_preview" src="" alt="Logo" />
      <div class="meta">
        <div class="corp" id="corp_name_view">ï¼ˆå…¬å¸æŠ¬é ­ï¼‰</div>
        <div class="sub" id="corp_sub_view">çµ±ç·¨ï¼šâ€”â€”ï½œé›»è©±ï¼šâ€”â€”ï½œEmailï¼šâ€”â€”</div>
      </div>
    </div>
    <div class="btns">
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°/å­˜ PDF</button>
      <button class="btn" onclick="exportJson()">â¬‡ï¸ åŒ¯å‡º JSON</button>
      <button class="btn" onclick="loadSample()">ğŸ§ª è¼‰å…¥ç¤ºä¾‹è³‡æ–™</button>
    </div>
  </div>

  <div class="block">
    <div class="h"><div class="t">å ±åƒ¹å–®è³‡è¨Š <em>Quote Info</em></div><span class="badge">å«ç¨… 5% é¡¯ç¤º</span></div>
    <div class="kv">
      <div class="box"><div class="lab">å ±åƒ¹å–®ç·¨è™Ÿ</div><div class="val" id="quote_no">-</div></div>
      <div class="box"><div class="lab">å ±åƒ¹æ—¥æœŸ</div><div class="val" id="quote_date_view">-</div></div>
      <div class="box"><div class="lab">æœ‰æ•ˆæœŸé™</div><div class="val" id="valid_until">-</div></div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div class="row"><label>å…¬å¸æŠ¬é ­</label><input id="corp_name" placeholder="ä¾‹ï¼šå±¹ç™»ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸"></div>
      <div class="row"><label>çµ±ä¸€ç·¨è™Ÿ</label><input id="corp_tax" placeholder="ä¾‹ï¼š12345678" inputmode="numeric"></div>
      <div class="row"><label>é›»è©±</label><input id="corp_tel" placeholder="ä¾‹ï¼š02-1234-5678"></div>
      <div class="row"><label>Email</label><input id="corp_email" placeholder="example@domain.com" inputmode="email"></div>
      <div class="row"><label>å…¬å¸åœ°å€</label><input id="corp_addr" placeholder="ä¾‹ï¼šå°åŒ—å¸‚â‹¯"></div>
      <div class="row"><label>å®˜ç¶²</label><input id="corp_site" placeholder="https://..." inputmode="url"></div>
      <div class="row"><label>Logo URL</label><input id="corp_logo" placeholder="https://...logo.png" inputmode="url"></div>
      <div class="row"><label>å ±åƒ¹æœ‰æ•ˆå¤©æ•¸</label>
        <select id="valid_days">
          <option value="7">7 å¤©</option><option value="14" selected>14 å¤©</option>
          <option value="30">30 å¤©</option><option value="60">60 å¤©</option>
        </select>
      </div>
      <div class="row"><label>æ”¶æ¬¾è³‡è¨Š</label><textarea id="corp_bank" placeholder="éŠ€è¡Œï¼šxxx éŠ€è¡Œ åˆ†è¡Œï½œæˆ¶åï¼šxxxï½œå¸³è™Ÿï¼šxxx-xxx-xxx"></textarea></div>
      <div class="row"><label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="pay_method">
          <option>åŒ¯æ¬¾</option><option>ç¾é‡‘</option><option>åˆ·å¡(5%)</option><option>ç„¡å¡åˆ†æœŸ(5%)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- å®¢æˆ¶è³‡æ–™ -->
  <div class="block">
    <div class="h"><div class="t">å®¢æˆ¶è³‡æ–™ <em>Client</em></div><span class="badge2">å¡«å¯«</span></div>
    <div class="grid2">
      <div class="row"><label>å…¬å¸/å€‹äºº</label><input id="cust_name" placeholder="ä¾‹ï¼šå±¹ç™»é¤é£²è‚¡ä»½æœ‰é™å…¬å¸"></div>
      <div class="row"><label>çµ±ç·¨/èº«åˆ†è­‰</label><input id="cust_tax" placeholder="ä¾‹ï¼š12345678" inputmode="numeric"></div>
      <div class="row"><label>è¯çµ¡äºº</label><input id="cust_contact" placeholder="ä¾‹ï¼šç‹å°æ˜"></div>
      <div class="row"><label>é›»è©±</label><input id="cust_phone" placeholder="ä¾‹ï¼š02-xxxxxxx / 09xx-xxx-xxx" inputmode="tel"></div>
      <div class="row"><label>Email</label><input id="cust_email" placeholder="example@domain.com" inputmode="email"></div>
      <div class="row"><label>åœ°å€</label><input id="cust_addr" placeholder="ä¾‹ï¼šé«˜é›„å¸‚â—¯â—¯å€â—¯â—¯è·¯â—¯è™Ÿ"></div>
    </div>
  </div>

  <!-- å»ºç½®è²» + SSL -->
  <div class="block">
    <div class="h"><div class="t">å»ºç½®è²»èˆ‡ SSL <em>Setup & SSL</em></div><span class="badge2">ä¸€æ¬¡æ€§ï¼‹å¹´è²»</span></div>
    <div class="flex">
      <label class="flex"><input type="checkbox" id="setup_enable" style="width:22px;height:22px" checked> <span style="margin-left:8px">ç³»çµ±å»ºç½®è²»</span></label>
      <select id="setup_choice" style="min-width:260px">
        <option value="CRM å»ºç½®è²»|15000">CRM å»ºç½®è²»ï¼ˆ15,000 å…ƒï¼‰</option>
        <option value="é¤é£²POS å»ºç½®è²»|18000">é¤é£²POS å»ºç½®è²»ï¼ˆ18,000 å…ƒï¼‰</option>
        <option value="ç¾æ¥­POS å»ºç½®è²»|20000">ç¾æ¥­POS å»ºç½®è²»ï¼ˆ20,000 å…ƒï¼‰</option>
        <option value="CRM é›»å•†å»ºç½®|25000">CRM é›»å•†å»ºç½®ï¼ˆ25,000 å…ƒï¼‰</option>
        <option value="å½±éŸ³é–‹èª²å»ºç½®è²»|35000">å½±éŸ³é–‹èª²å»ºç½®è²»ï¼ˆ35,000 å…ƒï¼‰</option>
      </select>
      <div class="row" style="margin:0;grid-template-columns:200px 220px">
        <label>SSL çµ„æ•¸ï¼ˆ$2,000/å¹´ï¼‰</label>
        <select id="ssl_qty"></select>
      </div>
    </div>
    <div class="small">ï¼Šå»ºç½®è²»ç‚ºä¸€æ¬¡æ€§ï¼Œç¸½é‡‘é¡å–®ä½ã€Œå…ƒã€ï¼›SSL è‡³å°‘ 1 çµ„ï¼Œåˆ—åœ¨è¨‚è³¼å…§å®¹æœ€å¾Œä¸€åˆ—ï¼ˆå–®ä½ã€Œå…ƒ/å¹´ã€ï¼‰ã€‚</div>
  </div>

  <!-- é›²ç«¯è³‡æ–™åº« -->
  <div class="block">
    <div class="h"><div class="t">é›²ç«¯è³‡æ–™åº« <em>Cloud Database</em></div><span class="badge2">å¯æ–°å¢å¤šç­†</span></div>
    <div id="cloud_rows"></div>
    <div class="line"></div>
    <button class="btn" onclick="addCloudRow()">ï¼‹ æ–°å¢ä¸€ç­†é›²ç«¯è³‡æ–™åº«</button>
    <div class="small">ï¼Šå¥—æ•¸ï¼š1â€“20ï¼›ã€ŒCRMå­ç¶²ã€éœ€æ‰‹å‹•è¼¸å…¥æœˆåƒ¹ï¼ˆè‡ªå‹•æ›ç®—å¹´åƒ¹ï¼‰ã€‚</div>
  </div>

  <!-- è¨‚è³¼å…§å®¹èªªæ˜ -->
  <div class="block summary">
    <div class="h"><div class="t">è¨‚è³¼å…§å®¹èªªæ˜ <em>Order Summary</em></div></div>
    <table id="pdf_like">
      <thead>
        <tr>
          <th>é …ç›®</th>
          <th class="num">å–®æ¬¡</th>
          <th class="num">å–®åƒ¹(æœˆ)</th>
          <th class="num">å–®åƒ¹(å¹´)</th>
          <th class="num">å¥—æ•¸</th>
          <th class="num">ç¸½é‡‘é¡</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="5" class="num">å°è¨ˆï¼ˆæœªç¨…ï¼‰</td><td class="num" id="pdf_sum">0</td></tr>
      </tfoot>
    </table>
  </div>

  <!-- åˆè¨ˆ / å‚™è¨» -->
  <div class="totalgrid">
    <div class="block termblock">
      <div class="h"><div class="t">å‚™è¨»èˆ‡æ¢æ¬¾ <em>Terms</em></div></div>
      <ul style="margin:0 0 6px 18px">
        <li>åƒ¹æ ¼å‡ç‚ºæœªç¨…ï¼Œåˆè¨ˆé¡¯ç¤ºå«ç¨… 5%ï¼ˆå°è¨ˆÃ—1.05ï¼‰ã€‚</li>
        <li>å ±åƒ¹æœ‰æ•ˆæœŸé™ä¾ä¸Šæ–¹ã€Œæœ‰æ•ˆæœŸé™ã€æ¬„ä½ç‚ºæº–ï¼Œé€¾æœŸè«‹é‡æ–°è©¢åƒ¹ã€‚</li>
        <li>å¦‚ä½¿ç”¨åˆ·å¡/ç„¡å¡åˆ†æœŸï¼Œå°‡å¦åŠ  5% æ‰‹çºŒè²»ã€‚</li>
        <li>é›²ç«¯æ–¹æ¡ˆä¹‹ç¸½é‡‘é¡å–®ä½ç‚ºã€Œå…ƒ/å¹´ã€ï¼Œå»ºç½®è²»ç‚ºã€Œå…ƒã€ã€‚</li>
        <li>æœ¬å ±åƒ¹æœªå«ç¡¬é«”å®‰è£å¸ƒç·šèˆ‡åˆ°åºœæœå‹™ï¼›è‹¥éœ€å¦è¨ˆã€‚</li>
      </ul>
      <div class="line"></div>
      <div class="small">æ”¶æ¬¾è³‡è¨Šï¼š<br><span id="bank_view">â€”</span></div>
    </div>

    <div class="block totalbox">
      <div class="row2"><div>å°è¨ˆï¼ˆæœªç¨…ï¼‰</div><div id="sum_ex">0</div></div>
      <div class="row2"><div>ç¨…é¡ï¼ˆ5%ï¼‰</div><div id="tax">0</div></div>
      <div class="row2"><strong>åˆè¨ˆï¼ˆå«ç¨…ï¼‰</strong><strong id="total_inc">0</strong></div>
      <div class="small" style="margin-top:6px">ä»˜æ¬¾æ–¹å¼ï¼š<span id="pay_view">åŒ¯æ¬¾</span></div>
    </div>
  </div>

  <!-- Sticky åˆè¨ˆï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ -->
  <div class="stickybar">
    <div>åˆè¨ˆï¼ˆå«ç¨…ï¼‰</div>
    <div class="fig" id="sticky_total">0</div>
    <div class="btns">
      <button class="btn primary" onclick="window.print()">åˆ—å°/å­˜PDF</button>
    </div>
  </div>

</div>

<script>
const $ = (sel)=>document.querySelector(sel);
const fmt = (n)=> Number.isFinite(+n) ? (+n).toLocaleString('zh-TW') : n;
const num = (v)=> { const n = parseFloat(String(v).replace(/[^\d.-]/g,'')); return isNaN(n)?0:n; };

// Quote number & dates
function genQuoteNo(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const rand = Math.floor(Math.random()*9000)+1000;
  return `Q${y}${m}${day}-${rand}`;
}
function refreshHeader(){
  $("#quote_no").textContent = window._quoteNo || (window._quoteNo = genQuoteNo());
  const d = new Date();
  $("#quote_date_view").textContent = d.toISOString().slice(0,10);
  const days = num($("#valid_days").value||14);
  const v = new Date(d.getTime()+days*24*60*60*1000);
  $("#valid_until").textContent = v.toISOString().slice(0,10);

  // company header preview
  $("#corp_name_view").textContent = $("#corp_name").value || "ï¼ˆå…¬å¸æŠ¬é ­ï¼‰";
  $("#corp_sub_view").textContent =
    `çµ±ç·¨ï¼š${$("#corp_tax").value||"â€”"}ï½œé›»è©±ï¼š${$("#corp_tel").value||"â€”"}ï½œEmailï¼š${$("#corp_email").value||"â€”"}`;
  const logo = $("#corp_logo").value.trim();
  $("#logo_preview").src = logo || "";
  $("#bank_view").textContent = $("#corp_bank").value || "â€”";
  $("#pay_view").textContent = $("#pay_method").value || "åŒ¯æ¬¾";
}

// SSL qty (1..20)
(function(){ const sel = document.getElementById('ssl_qty'); for(let i=1;i<=20;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; if(i===1) o.selected=true; sel.appendChild(o);} })();

// Cloud options (CRMå­ç¶²ç‚ºæ‰‹å‹•ï¼Œç½®æ–¼ç¸½åº—ç³»çµ±ä¸‹æ–¹)
const CLOUD_OPTIONS = [
  {name:"ç¸½åº—ç³»çµ±", yearly:60000},
  {name:"CRMå­ç¶²", manual:true},
  {name:"CRM(å–®åº—)ï¼å¾®åº—ç‰ˆ", monthly:3000},
  {name:"CRM(å–®åº—)ï¼å°ˆæ¥­ç‰ˆ", monthly:4000},
  {name:"CRM(å–®åº—)ï¼è£‚è®Šç‰ˆ", monthly:5000},
  {name:"CRM+POSï¼å°è³‡ç‰ˆ", monthly:3600},
  {name:"CRM+POSï¼æ”¤å•†ç‰ˆ", monthly:4600},
  {name:"CRM+POSï¼é–€åº—ç‰ˆ", monthly:5600},
  {name:"ç¾æ¥­é ç´„POSï¼å‰µæ¥­ç‰ˆ", monthly:3600},
  {name:"ç¾æ¥­é ç´„POSï¼å°ˆå®¶ç‰ˆ", monthly:4600},
  {name:"ç¾æ¥­é ç´„POSï¼ä¼æ¥­ç‰ˆ", monthly:5600},
  {name:"å½±éŸ³é–‹èª²(500G)", monthly:5500},
  {name:"é›»å•†å¹³å°", yearly:18000},
  {name:"æ´¾å·¥POS", yearly:12000},
];

function cloudOptionsHTML(){
  return CLOUD_OPTIONS.map((o)=>{
    if(o.manual){
      return `<option value="man||${o.name}">${o.name}ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼æœˆï¼‰</option>`;
    }
    const label = o.monthly ? `${o.name}ï¼ˆ${o.monthly.toLocaleString('zh-TW')} å…ƒ/æœˆï¼‰` : `${o.name}ï¼ˆ${o.yearly.toLocaleString('zh-TW')} å…ƒ/å¹´ï¼‰`;
    const value = o.monthly ? `m|${o.monthly}|${o.name}` : `y|${o.yearly}|${o.name}`;
    return `<option value="${value}">${label}</option>`;
  }).join('');
}

function qtySelectHTML(defaultVal=1){
  const opts = [];
  for(let i=1;i<=20;i++){
    opts.push(`<option ${i===defaultVal?'selected':''}>${i}</option>`);
  }
  return `<select class="qtySel">${opts.join('')}</select>`;
}

function cloudRowHTML(){
  return `<div class="flex cloudRow" style="gap:10px;align-items:center;margin-bottom:8px">
    <select class="cloudSel" style="min-width:360px">${cloudOptionsHTML()}</select>
    <span class="manualBox">å–®åƒ¹(æœˆ)ï¼š<input class="manualPrice" type="number" inputmode="numeric" placeholder="è«‹è¼¸å…¥"> å…ƒ</span>
    <div>å¥—æ•¸ï¼š${qtySelectHTML(1)}</div>
    <button class="rm" title="ç§»é™¤">ç§»é™¤</button>
  </div>`;
}

function addCloudRow(){
  const container = document.getElementById("cloud_rows");
  container.insertAdjacentHTML("beforeend", cloudRowHTML());
  bindCloudEvents(container.lastElementChild);
  calc();
}

function bindCloudEvents(row){
  const sel = row.querySelector(".cloudSel");
  const box = row.querySelector(".manualBox");
  const price = row.querySelector(".manualPrice");
  function toggleManual(){
    if(sel.value.startsWith("man|")){
      box.style.display = "inline-flex";
      price.focus();
    }else{
      box.style.display = "none";
      price.value = "";
    }
    calc();
  }
  sel.addEventListener("change", toggleManual);
  row.querySelector(".qtySel").addEventListener("change", calc);
  price.addEventListener("input", calc);
  row.querySelector(".rm").addEventListener("click", ()=>{ row.remove(); calc(); });
  toggleManual();
}

// Inputs change to refresh header and totals
["corp_name","corp_tax","corp_tel","corp_email","corp_logo","corp_addr","corp_site","valid_days","corp_bank","pay_method"]
.forEach(id=> document.addEventListener("input", (e)=>{ if(e.target.id===id) refreshHeader(); }));
document.addEventListener("change", (e)=>{ if(e.target.id==="valid_days"||e.target.id==="pay_method") refreshHeader(); });

function readSetup(){
  const enabled = document.getElementById("setup_enable").checked;
  const choice = document.getElementById("setup_choice").value; // "name|price"
  const [name, price] = choice.split("|");
  return enabled ? {name, price: num(price)} : null;
}

function readCloudRows(){
  const rows = [...document.querySelectorAll(".cloudRow")];
  return rows.map(r=>{
    const sel = r.querySelector(".cloudSel").value; // "m|price|name" / "y|price|name" / "man||name"
    const [type, price, name] = sel.split("|");
    const qty = num(r.querySelector(".qtySel").value);
    if(type==="man"){
      const pm = num(r.querySelector(".manualPrice").value||0);
      const yearly = pm*12;
      return {name, monthly: pm, yearly, qty};
    }else{
      const monthly = (type==="m") ? num(price) : 0;
      const yearly = (type==="y") ? num(price) : (num(price)*12);
      return {name, monthly: (type==="m")?monthly:Math.round(yearly/12), yearly, qty};
    }
  });
}

function rebuildPdfTable(){
  const tb = document.querySelector("#pdf_like tbody");
  tb.innerHTML = "";
  let subtotal = 0;

  // Setup (once)
  const setup = readSetup();
  if(setup){
    const sub = setup.price; subtotal += sub;
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${setup.name}</td>
        <td class="num">${fmt(setup.price)} å…ƒ</td>
        <td class="num"></td>
        <td class="num"></td>
        <td class="num">1</td>
        <td class="num">${fmt(sub)} å…ƒ</td>
      </tr>
    `);
  }

  // Cloud rows
  const clouds = readCloudRows();
  clouds.forEach(c=>{
    const sub = c.yearly * c.qty; subtotal += sub;
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${c.name}</td>
        <td class="num"></td>
        <td class="num">${fmt(c.monthly)}</td>
        <td class="num">${fmt(c.yearly)}</td>
        <td class="num">${c.qty}</td>
        <td class="num">${fmt(sub)} å…ƒ/å¹´</td>
      </tr>
    `);
  });

  // SSL last row
  const sslQty = num(document.getElementById("ssl_qty").value)||1;
  const sslYearly = 2000;
  const sslSub = sslQty * sslYearly; subtotal += sslSub;
  tb.insertAdjacentHTML("beforeend", `
    <tr>
      <td>SSL å¹´è²»</td>
      <td class="num"></td>
      <td class="num">${fmt(Math.round(sslYearly/12))}</td>
      <td class="num">${fmt(sslYearly)}</td>
      <td class="num">${sslQty}</td>
      <td class="num">${fmt(sslSub)} å…ƒ/å¹´</td>
    </tr>
  `);

  // Totals
  document.getElementById("pdf_sum").textContent = fmt(subtotal);
  const tax = Math.round(subtotal * 0.05);
  const total = subtotal + tax;
  document.getElementById("sum_ex").textContent = fmt(subtotal);
  document.getElementById("tax").textContent = fmt(tax);
  document.getElementById("total_inc").textContent = fmt(total);
  document.getElementById("sticky_total").textContent = fmt(total);
}

function calc(){ rebuildPdfTable(); }

function exportJson(){
  const rows = document.querySelectorAll("#pdf_like tbody tr");
  const pdfRows = [];
  rows.forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    pdfRows.push({
      item: tds[0].textContent.trim(),
      once: tds[1].textContent.trim(),
      price_m: tds[2].textContent.trim(),
      price_y: tds[3].textContent.trim(),
      sets: tds[4].textContent.trim(),
      total: tds[5].textContent.trim(),
    });
  });
  const payload = {
    quote:{
      number: document.getElementById("quote_no").textContent,
      date: document.getElementById("quote_date_view").textContent,
      valid_until: document.getElementById("valid_until").textContent,
    },
    company:{
      name: $("#corp_name").value, tax: $("#corp_tax").value, tel: $("#corp_tel").value,
      email: $("#corp_email").value, addr: $("#corp_addr").value, site: $("#corp_site").value,
      logo: $("#corp_logo").value, bank: $("#corp_bank").value
    },
    client:{
      name: $("#cust_name").value, tax: $("#cust_tax").value, contact: $("#cust_contact").value,
      phone: $("#cust_phone").value, email: $("#cust_email").value, addr: $("#cust_addr").value
    },
    pay_method: $("#pay_method").value,
    ssl_qty: Number($("#ssl_qty").value),
    table: pdfRows,
    subtotal_ex_tax: document.getElementById("sum_ex").textContent,
    tax_5pct: document.getElementById("tax").textContent,
    total_incl_tax: document.getElementById("total_inc").textContent,
    generated_at: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `MECANGO_æ­£å¼å ±åƒ¹_v4_${(new Date()).toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// Sample data quick fill
function loadSample(){
  $("#corp_name").value="å±¹ç™»ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸";
  $("#corp_tax").value="12345678";
  $("#corp_tel").value="02-2345-6789";
  $("#corp_email").value="sales@example.com";
  $("#corp_addr").value="å°åŒ—å¸‚ä¿¡ç¾©å€å¸‚åºœè·¯1è™Ÿ";
  $("#corp_site").value="https://example.com";
  $("#corp_logo").value="";
  $("#corp_bank").value="éŠ€è¡Œï¼šç¬¬ä¸€éŠ€è¡Œ æ¾å±±åˆ†è¡Œï½œæˆ¶åï¼šå±¹ç™»ç§‘æŠ€ï½œå¸³è™Ÿï¼š123-456-789012";
  $("#cust_name").value="å°å­©ç¸½åº—è‚¡ä»½æœ‰é™å…¬å¸";
  $("#cust_tax").value="24681357";
  $("#cust_contact").value="æ—å°å§";
  $("#cust_phone").value="02-8888-0000";
  $("#cust_email").value="owner@example.com";
  $("#cust_addr").value="é«˜é›„å¸‚å‰é®å€ä¸­å±±äºŒè·¯";
  refreshHeader();
  calc();
}

document.addEventListener("DOMContentLoaded", ()=>{
  // initial cloud row
  addCloudRow();
  // wire events
  document.getElementById("setup_enable").addEventListener("change", calc);
  document.getElementById("setup_choice").addEventListener("change", calc);
  document.getElementById("ssl_qty").addEventListener("change", calc);
  refreshHeader();
  calc();
});
</script>
</body>
</html>
