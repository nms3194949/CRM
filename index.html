<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MECANGOï½œæ­£å¼å ±åƒ¹å–®ï¼ˆv5.7ï¼‰</title>
<style>
:root{
  --deep:#0A1221; --gold:#C9A227; --gold-soft:#E9D18A;
  --card:#0C152A; --ink:#e7ecf3; --muted:#9aa4b2; --line:rgba(233,209,138,.28);
  --ink-2:#cfd6e3;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--deep);color:var(--ink);font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif;line-height:1.5}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0C152A,#0A1221)}
.brand{display:flex;gap:12px;align-items:center}
.brand img{width:56px;height:56px;object-fit:contain;border-radius:12px;border:1px solid var(--line);background:#0b1430}
.brand .meta{display:grid;gap:4px}
.brand .meta .corp{font-weight:800;font-size:18px;letter-spacing:.5px}
.brand .meta .sub{font-size:12px;color:var(--ink-2)}
.block{border:1px solid var(--line);border-radius:14px;padding:12px;background:var(--card);margin-top:12px}
.h{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.h .t{font-weight:800}
.h .t em{font-style:normal;color:var(--gold-soft)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
.row{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
.row label{color:var(--muted);font-size:14px}
.row input,.row select{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--line);background:#071226;color:var(--ink);font-size:15px}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--line);background:transparent;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-size:15px}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold)}
.flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.line{border-top:1px dashed var(--line);margin:10px 0}
.rm{cursor:pointer;border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#0a152a}
.small{font-size:12px;color:var(--muted)}

.summary{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.summary table{width:100%;border-collapse:collapse}
.summary th,.summary td{padding:12px;border-bottom:1px solid var(--line)}
.summary thead th{background:#0e1830}
.summary .num{text-align:right;white-space:nowrap}
.summary tfoot td{font-weight:700}

.totalgrid{display:grid;grid-template-columns:1fr 300px;gap:12px;align-items:flex-start}
.totalbox{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1630}
.totalbox .row2{display:flex;justify-content:space-between;margin:6px 0}
.totalbox .row2 strong{font-size:18px}
.termblock{border:1px dashed var(--line);border-radius:12px;padding:10px}

.stickybar{position:sticky;bottom:8px;left:0;right:0;margin-top:12px;display:flex;gap:8px;justify-content:space-between;align-items:center;background:rgba(12,21,42,.9);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:12px;padding:8px 12px}
.stickybar .fig{font-weight:800;font-size:18px}

/* NEW: four-block grid layout */
.config-grid{
  display:grid;
  grid-template-columns:repeat(2, minmax(0,1fr));
  gap:12px;
}
@media (max-width:900px){
  .config-grid{ grid-template-columns:1fr }
}

/* PRINT STYLES */
@media print{
  @page{ size:A4; margin:10mm; }
  body{ background:#fff; color:#000; }
  .wrap{ max-width:none; padding:0 }
  .btns,.stickybar{ display:none !important }
  /* Default: hide configuration blocks */
  .print-hide{ display:none !important }

  /* Excel mode overrides when body has .excel-mode */
  body.excel-mode .header{ display:none !important }
  body.excel-mode .block{ border:0; background:#fff; }
  body.excel-mode .print-hide{ display:none !important }
  body.excel-mode .termblock, body.excel-mode .totalbox{ display:none !important }
  body.excel-mode .summary{ border:0 }
  body.excel-mode .summary thead th{ background:#fff; color:#000; }
  body.excel-mode .summary table{
    border-collapse:collapse;
    width:100%;
    font-size:11px;
  }
  body.excel-mode .summary th, 
  body.excel-mode .summary td{
    border:1px solid #000;
    padding:6px 6px;
  }
  body.excel-mode .summary tfoot td{
    font-weight:700;
    border-top:2px solid #000;
  }
  /* Excel-mode header rows shown as a small table */
  body.excel-mode #excel_header{ display:block !important }
}

/* Hidden by default, shown only in excel-mode print */
#excel_header{ display:none; margin-top:12px }
#excel_header table{ width:100%; border-collapse:collapse; background:#fff; color:#000 }
#excel_header th,#excel_header td{ border:1px solid #000; padding:6px 8px; font-size:11px; text-align:left }
#excel_header .title{ font-weight:800 }

</style>
</head>
<body>
<div class="wrap">

  <!-- é é¦– -->
  <div class="header">
    <div class="brand">
      <img id="logo_preview" src="https://crmpos.mecango.com/_files/49/9040149/f/eae0f725de036939.png" alt="Logo" />
      <div class="meta">
        <div class="corp" id="corp_name_view">å±¹ç™»è‚¡ä»½æœ‰é™å…¬å¸</div>
        <div class="sub" id="corp_sub_view">çµ±ç·¨ï¼š90693783ï½œåœ°å€ï¼šé«˜é›„å¸‚å·¦ç‡Ÿå€å­Ÿå­è·¯37è™Ÿ3æ¨“</div>
      </div>
    </div>
    <div class="btns">
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ ä¸€èˆ¬åˆ—å°</button>
      <button class="btn" onclick="enableExcelMode()">ğŸ“„ è¡¨æ ¼å¼åˆ—å°</button>
      <button class="btn" onclick="exportJson()">â¬‡ï¸ åŒ¯å‡º JSON</button>
    </div>
  </div>

  <!-- å ±åƒ¹å–®è³‡è¨Š -->
  <div class="block">
    <div class="h"><div class="t">å ±åƒ¹å–®è³‡è¨Š <em>Quote Info</em></div><span class="badge">åˆè¨ˆé¡¯ç¤ºå«ç¨…5%</span></div>
    <div class="grid2">
      <div class="row"><label>å ±åƒ¹æ—¥æœŸ</label><input id="quote_date_view" type="date"></div>
      <div class="row"><label>å…¬å¸æŠ¬é ­</label><input id="corp_name" placeholder=""></div>
      <div class="row"><label>è¯çµ¡äºº</label><input id="contact_person" placeholder=""></div>
      <div class="row"><label>çµ±ä¸€ç·¨è™Ÿ</label><input id="corp_tax" placeholder="" inputmode="numeric"></div>
      <div class="row"><label>é›»è©±</label><input id="corp_tel" placeholder="" inputmode="tel"></div>
      <div class="row"><label>Email</label><input id="corp_email" placeholder="" inputmode="email"></div>
      <div class="row"><label>å…¬å¸åœ°å€</label><input id="corp_addr" placeholder=""></div>
      <div class="row"><label>å®˜ç¶²</label><input id="corp_site" placeholder="" inputmode="url"></div>
      <div class="row"><label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="pay_method">
          <option>åŒ¯æ¬¾</option><option>ç¾é‡‘</option><option>åˆ·å¡(5%)</option><option>ç„¡å¡åˆ†æœŸ(5%)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ä¸¦æ’å…©æ’ï¼šç³»çµ±å¹³å° / é›²ç«¯è³‡æ–™åº« / åŠ å€¼æœå‹™ / è¨­å‚™ -->
  <div class="config-grid">
    <!-- ç³»çµ±å¹³å° -->
    <div class="block print-hide">
      <div class="h"><div class="t">ç³»çµ±å¹³å° <em>Platform</em></div><span class="badge2">ä¸€æ¬¡æ€§ï¼‹å¹´è²»</span></div>
      <div class="flex">
        <label class="flex"><input type="checkbox" id="setup_enable" style="width:22px;height:22px" checked> <span style="margin-left:8px">ç³»çµ±å»ºç½®è²»</span></label>
        <select id="setup_choice" style="min-width:260px">
          <option value="CRM å»ºç½®è²»|15000">CRM å»ºç½®è²»ï¼ˆ15,000 å…ƒï¼‰</option>
          <option value="é¤é£²POS å»ºç½®è²»|18000">é¤é£²POS å»ºç½®è²»ï¼ˆ18,000 å…ƒï¼‰</option>
          <option value="ç¾æ¥­POS å»ºç½®è²»|20000">ç¾æ¥­POS å»ºç½®è²»ï¼ˆ20,000 å…ƒï¼‰</option>
          <option value="CRM é›»å•†å»ºç½®|25000">CRM é›»å•†å»ºç½®ï¼ˆ25,000 å…ƒï¼‰</option>
          <option value="å½±éŸ³é–‹èª²å»ºç½®è²»|35000">å½±éŸ³é–‹èª²å»ºç½®è²»ï¼ˆ35,000 å…ƒï¼‰</option>
        </select>
      </div>
      <div class="flex" style="margin-top:6px">
        <span>ç©ºé–“/äººæ•¸</span>
        <select id="space_tier" style="min-width:260px">
          <option value="0|50G/10,000äºº $0/æœˆ">50G/10,000äºº $0/æœˆ</option>
          <option value="500|100G/2è¬äºº +$500/æœˆ">100G/2è¬äºº +$500/æœˆ</option>
          <option value="1000|100G/5è¬äºº +$1,000/æœˆ">100G/5è¬äºº +$1,000/æœˆ</option>
          <option value="1500|200G/10è¬äºº +$1,500/æœˆ">200G/10è¬äºº +$1,500/æœˆ</option>
        </select>
      </div>
      <div class="flex" style="margin-top:6px">
        <span>SSL çµ„æ•¸ï¼ˆ$2,000/å¹´ï¼‰</span>
        <select id="ssl_qty" style="min-width:120px"></select>
      </div>
    </div>

    <!-- é›²ç«¯è³‡æ–™åº« -->
    <div class="block print-hide">
      <div class="h"><div class="t">é›²ç«¯è³‡æ–™åº« <em>Cloud Database</em></div><span class="badge2">å¯æ–°å¢å¤šç­†</span></div>
      <div id="cloud_rows"></div>
      <div class="line"></div>
      <button class="btn" onclick="addCloudRow()">ï¼‹ æ–°å¢ä¸€ç­†é›²ç«¯è³‡æ–™åº«</button>
    </div>

    <!-- åŠ å€¼æœå‹™ -->
    <div class="block print-hide">
      <div class="h"><div class="t">åŠ å€¼æœå‹™ <em>Add-ons</em></div><span class="badge2">å¯æ–°å¢å¤šç­†</span></div>
      <div id="addon_rows"></div>
      <div class="line"></div>
      <button class="btn" onclick="addAddonRow()">ï¼‹ æ–°å¢åŠ å€¼æœå‹™</button>
    </div>

    <!-- è¨­å‚™ -->
    <div class="block print-hide">
      <div class="h"><div class="t">è¨­å‚™ <em>Hardware</em></div><span class="badge2">å¯æ–°å¢å¤šç­†</span></div>
      <div id="device_rows"></div>
      <div class="line"></div>
      <button class="btn" onclick="addDeviceRow()">ï¼‹ æ–°å¢è¨­å‚™</button>
    </div>
  </div>

  <!-- è¨‚è³¼å…§å®¹èªªæ˜ -->
  <div class="block summary">
    <div class="h"><div class="t">è¨‚è³¼å…§å®¹èªªæ˜ <em>Order Summary</em></div></div>
    <table id="pdf_like">
      <thead>
        <tr>
          <th>é …ç›®</th>
          <th class="num">å–®æ¬¡</th>
          <th class="num">å–®åƒ¹(æœˆ)</th>
          <th class="num">å–®åƒ¹(å¹´)</th>
          <th class="num">å¥—æ•¸</th>
          <th class="num">ç¸½é‡‘é¡</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="5" class="num">å°è¨ˆï¼ˆæœªç¨…ï¼‰</td><td class="num" id="pdf_sum">0</td></tr>
      </tfoot>
    </table>
  </div>

  <!-- Excel-mode å°ˆç”¨ï¼šç°¡è¦æŠ¬é ­ï¼ˆå°å‡ºæ™‚æ‰é¡¯ç¤ºï¼‰ -->
  <div id="excel_header">
    <table>
      <tr><th class="title" colspan="4">æ­£å¼å ±åƒ¹å–®</th></tr>
      <tr><th>å ±åƒ¹æ—¥æœŸ</th><td id="x_date"></td><th>å…¬å¸æŠ¬é ­</th><td id="x_name"></td></tr>
      <tr><th>è¯çµ¡äºº</th><td id="x_contact"></td><th>çµ±ä¸€ç·¨è™Ÿ</th><td id="x_tax"></td></tr>
      <tr><th>é›»è©±</th><td id="x_tel"></td><th>Email</th><td id="x_email"></td></tr>
      <tr><th>å…¬å¸åœ°å€</th><td colspan="3" id="x_addr"></td></tr>
      <tr><th>å®˜ç¶²</th><td colspan="3" id="x_site"></td></tr>
    </table>
  </div>

  <!-- å‚™è¨» / åˆè¨ˆ / åŒ¯æ¬¾è³‡è¨Š -->
  <div class="totalgrid">
    <div class="block termblock">
      <div class="h"><div class="t">å‚™è¨»èˆ‡æ¢æ¬¾ <em>Terms</em></div></div>
      <ul style="margin:0 0 6px 18px">
        <li>åƒ¹æ ¼å‡ç‚ºæœªç¨…ï¼Œåˆè¨ˆé¡¯ç¤ºå«ç¨… 5%ã€‚</li>
        <li>å ±åƒ¹æœ‰æ•ˆæœŸé™ç‚º30å¤©ï¼Œé€¾æœŸè«‹é‡æ–°è©¢åƒ¹ã€‚</li>
        <li>å¦‚ä½¿ç”¨åˆ·å¡/ç„¡å¡åˆ†æœŸï¼Œå°‡å¦åŠ æ‰‹çºŒè²»ã€‚</li>
      </ul>
      <div class="line"></div>
      <div>
        <div class="t" style="font-weight:700;margin:4px 0 6px 0">åŒ¯æ¬¾è³‡è¨Š</div>
        <div class="small">
          æˆ¶åï¼šå±¹ç™»è‚¡ä»½æœ‰é™å…¬å¸<br>
          éŠ€è¡Œï¼š807æ°¸è±éŠ€è¡ŒåŒ—é«˜é›„åˆ†è¡Œ<br>
          å¸³è™Ÿï¼š04201810038503
        </div>
      </div>
    </div>

    <div class="block totalbox">
      <div class="row2"><div>å°è¨ˆï¼ˆæœªç¨…ï¼‰</div><div id="sum_ex">0</div></div>
      <div class="row2"><div>ç¨…é¡ï¼ˆ5%ï¼‰</div><div id="tax">0</div></div>
      <div class="row2"><strong>åˆè¨ˆï¼ˆå«ç¨…ï¼‰</strong><strong id="total_inc">0</strong></div>
      <div class="small" style="margin-top:6px">ä»˜æ¬¾æ–¹å¼ï¼š<span id="pay_view">åŒ¯æ¬¾</span></div>
    </div>
  </div>

  <!-- Sticky åˆè¨ˆï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ -->
  <div class="stickybar">
    <div>åˆè¨ˆï¼ˆå«ç¨…ï¼‰</div>
    <div class="fig" id="sticky_total">0</div>
    <div class="btns">
      <button class="btn primary" onclick="window.print()">ğŸ–¨ï¸ ä¸€èˆ¬åˆ—å°</button>
      <button class="btn" onclick="enableExcelMode()">ğŸ“„ è¡¨æ ¼å¼åˆ—å°</button>
    </div>
  </div>

</div>

<script>
const $ = (sel)=>document.querySelector(sel);
const fmt = (n)=> Number.isFinite(+n) ? (+n).toLocaleString('zh-TW') : n;
const num = (v)=> { const n = parseFloat(String(v).replace(/[^\d.-]/g,'')); return isNaN(n)?0:n; };

function initQuoteDate(){ const d=new Date(),ds=d.toISOString().slice(0,10); const el=$("#quote_date_view"); if(!el.value) el.value=ds; }
(function initSSL(){ const sel=$("#ssl_qty"); if(!sel) return; sel.innerHTML=""; for(let i=1;i<=20;i++){const o=document.createElement('option'); o.value=i; o.textContent=i; if(i===1) o.selected=true; sel.appendChild(o);} })();

// Options
const CLOUD_OPTIONS = [
  {name:"ç¸½åº—ç³»çµ±", yearly:60000},
  {name:"CRMå­ç¶²", manual:true},
  {name:"CRM(å–®åº—)ï¼å¾®åº—ç‰ˆ", monthly:3000},
  {name:"CRM(å–®åº—)ï¼å°ˆæ¥­ç‰ˆ", monthly:4000},
  {name:"CRM(å–®åº—)ï¼è£‚è®Šç‰ˆ", monthly:5000},
  {name:"CRM+POSï¼å°è³‡ç‰ˆ", monthly:3600},
  {name:"CRM+POSï¼æ”¤å•†ç‰ˆ", monthly:4600},
  {name:"CRM+POSï¼é–€åº—ç‰ˆ", monthly:5600},
  {name:"ç¾æ¥­é ç´„POSï¼å‰µæ¥­ç‰ˆ", monthly:3600},
  {name:"ç¾æ¥­é ç´„POSï¼å°ˆå®¶ç‰ˆ", monthly:4600},
  {name:"ç¾æ¥­é ç´„POSï¼ä¼æ¥­ç‰ˆ", monthly:5600},
  {name:"å½±éŸ³é–‹èª²(500G)", monthly:5500},
  {name:"é›»å•†å¹³å°", yearly:18000},
  {name:"æ´¾å·¥POS", yearly:12000},
];
const ADDON_OPTIONS = [
  {name:"è¨‚ä½/é ç´„ç³»çµ±", yearly:15000},
  {name:"å¤šå…ƒæ”¯ä»˜", yearly:5000},
  {name:"å¤šåº—æ ¸éŠ·", monthly:1000},
  {name:"é›»å­ç™¼ç¥¨(è—æ–°)", once:3500},
  {name:"æ¨è–¦é›†é»", yearly:5000},
  {name:"é¸å–®ä¿®æ”¹", once:3000},
];
const DEVICE_OPTIONS = [
  {name:"Wifi+USBå‡ºå–®æ©Ÿ(80mm)", once:5500, unit:"å°"},
  {name:"Wifi+USBå‡ºå–®æ©Ÿ(58mm)+ç™¼ç¥¨æ©Ÿ", once:8500, unit:"å°"},
  {name:"Wifi+USBæ¨™ç±¤è²¼ç´™æ©Ÿ", once:6500, unit:"å°"},
  {name:"å‡ºå–®ç´™(80*80)", once:1800},
  {name:"ç™¼ç¥¨ç´™", once:1980},
  {name:"æ¨™ç±¤ç´™(100å·)", once:27000},
  {name:"äºŒç¶­æ¢ç¢¼å™¨_ç„¡ç·šè—ç‰™", once:1800, unit:"æ”¯"},
  {name:"é›»å­éŒ¢æ«ƒ", once:1980, unit:"æ”¯"},
];

function cloudOptionsHTML(){
  return CLOUD_OPTIONS.map(o=>{
    if(o.manual) return `<option value="man||${o.name}">${o.name}ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼æœˆï¼‰</option>`;
    const label = o.monthly ? `${o.name}ï¼ˆ${o.monthly.toLocaleString('zh-TW')} å…ƒ/æœˆï¼‰` : `${o.name}ï¼ˆ${o.yearly.toLocaleString('zh-TW')} å…ƒ/å¹´ï¼‰`;
    const value = o.monthly ? `m|${o.monthly}|${o.name}` : `y|${o.yearly}|${o.name}`;
    return `<option value="${value}">${label}</option>`;
  }).join('');
}
function addonOptionsHTML(){
  return ADDON_OPTIONS.map(o=>{
    if(o.once) return `<option value="o|${o.once}|${o.name}">${o.name}ï¼ˆ${o.once.toLocaleString('zh-TW')} å…ƒ/æ¬¡ï¼‰</option>`;
    if(o.monthly) return `<option value="m|${o.monthly}|${o.name}">${o.name}ï¼ˆ${o.monthly.toLocaleString('zh-TW')} å…ƒ/æœˆï¼‰</option>`;
    return `<option value="y|${o.yearly}|${o.name}">${o.name}ï¼ˆ${o.yearly.toLocaleString('zh-TW')} å…ƒ/å¹´ï¼‰</option>`;
  }).join('');
}
function deviceOptionsHTML(){
  return DEVICE_OPTIONS.map(o=>`<option value="o|${o.once}|${o.name}">${o.name}ï¼ˆ${o.once.toLocaleString('zh-TW')} å…ƒ${o.unit?"/"+o.unit:""}ï¼‰</option>`).join('');
}

function qtySelectHTML(cls="qtySel",max=20,def=1){
  const opts=[]; for(let i=1;i<=max;i++){opts.push(`<option ${i===def?'selected':''}>${i}</option>`)}; return `<select class="${cls}">${opts.join('')}</select>`;
}

function cloudRowHTML(){
  return `<div class="flex cloudRow" style="gap:10px;align-items:center;margin-bottom:8px">
    <select class="cloudSel" style="min-width:360px">${cloudOptionsHTML()}</select>
    <span class="manualBox">å–®åƒ¹(æœˆ)ï¼š<input class="manualPrice" type="number" inputmode="numeric" placeholder="è«‹è¼¸å…¥"> å…ƒ</span>
    <div>å¥—æ•¸ï¼š${qtySelectHTML("qtySel",20,1)}</div>
    <button class="rm" title="ç§»é™¤">ç§»é™¤</button>
  </div>`;
}
function addonRowHTML(){
  return `<div class="flex addonRow" style="gap:10px;align-items:center;margin-bottom:8px">
    <select class="addonSel" style="min-width:360px">${addonOptionsHTML()}</select>
    <div>å¥—æ•¸ï¼š${qtySelectHTML("qtySel",20,1)}</div>
    <button class="rm" title="ç§»é™¤">ç§»é™¤</button>
  </div>`;
}
function deviceRowHTML(){
  return `<div class="flex deviceRow" style="gap:10px;align-items:center;margin-bottom:8px">
    <select class="deviceSel" style="min-width:360px">${deviceOptionsHTML()}</select>
    <div>æ•¸é‡ï¼š${qtySelectHTML("qtySel",50,1)}</div>
    <button class="rm" title="ç§»é™¤">ç§»é™¤</button>
  </div>`;
}

function addCloudRow(){
  const c=$("#cloud_rows"); c.insertAdjacentHTML("beforeend", cloudRowHTML());
  const row=c.lastElementChild; bindCloudEvents(row);
  const sel=row.querySelector(".cloudSel"); const target="m|5000|CRM(å–®åº—)ï¼è£‚è®Šç‰ˆ";
  const opt=[...sel.options].find(o=>o.value===target); if(opt) sel.value=target;
  sel.dispatchEvent(new Event('change')); calc();
}
function addAddonRow(){ const c=$("#addon_rows"); c.insertAdjacentHTML("beforeend", addonRowHTML()); bindAddonEvents(c.lastElementChild); calc(); }
function addDeviceRow(){ const c=$("#device_rows"); c.insertAdjacentHTML("beforeend", deviceRowHTML()); bindDeviceEvents(c.lastElementChild); calc(); }

function bindCloudEvents(row){
  const sel=row.querySelector(".cloudSel"), box=row.querySelector(".manualBox"), price=row.querySelector(".manualPrice");
  function toggle(){ if(sel.value.startsWith("man|")){box.style.display="inline-flex"; price.focus();} else {box.style.display="none"; price.value="";} calc(); }
  sel.addEventListener("change", toggle);
  row.querySelector(".qtySel").addEventListener("change", calc);
  price.addEventListener("input", calc);
  row.querySelector(".rm").addEventListener("click", ()=>{row.remove(); calc();});
  toggle();
}
function bindAddonEvents(row){
  row.querySelector(".addonSel").addEventListener("change", calc);
  row.querySelector(".qtySel").addEventListener("change", calc);
  row.querySelector(".rm").addEventListener("click", ()=>{ row.remove(); calc(); });
}
function bindDeviceEvents(row){
  row.querySelector(".deviceSel").addEventListener("change", calc);
  row.querySelector(".qtySel").addEventListener("change", calc);
  row.querySelector(".rm").addEventListener("click", ()=>{ row.remove(); calc(); });
}

function headerPreview(){
  const name=$("#corp_name").value || "ï¼ˆå…¬å¸æŠ¬é ­ï¼‰";
  $("#corp_name_view").textContent=name;
  // fill excel header fields
  $("#x_date").textContent = $("#quote_date_view").value || "";
  $("#x_name").textContent = $("#corp_name").value || "";
  $("#x_contact").textContent = $("#contact_person").value || "";
  $("#x_tax").textContent = $("#corp_tax").value || "";
  $("#x_tel").textContent = $("#corp_tel").value || "";
  $("#x_email").textContent = $("#corp_email").value || "";
  $("#x_addr").textContent = $("#corp_addr").value || "";
  $("#x_site").textContent = $("#corp_site").value || "";
}
["corp_name","contact_person","corp_tax","corp_tel","corp_email","corp_addr","corp_site","quote_date_view"].forEach(id=>{
  document.addEventListener("input",(e)=>{ if(e.target && e.target.id===id) headerPreview(); });
});

function readSetup(){
  const enabled=$("#setup_enable")?.checked;
  if(!enabled) return null;
  const [name,price]=($("#setup_choice").value||"").split("|");
  return {name, price:num(price)};
}
function readSpaceTier(){
  const el=$("#space_tier"); if(!el) return null;
  const [m,label]=el.value.split("|"); const monthly=num(m);
  return {name:`é›²ç«¯ç©ºé–“/äººæ•¸æ–¹æ¡ˆï¼ˆ${label}ï¼‰`, monthly, yearly:monthly*12, qty:1};
}
function readCloudRows(){
  return [...document.querySelectorAll(".cloudRow")].map(r=>{
    const [type, price, name] = r.querySelector(".cloudSel").value.split("|");
    const qty = num(r.querySelector(".qtySel").value);
    if(type==="man"){
      const pm = num(r.querySelector(".manualPrice").value||0);
      return {name, monthly:pm, yearly:pm*12, qty};
    }else{
      const monthly=(type==="m")?num(price):Math.round(num(price)/12);
      const yearly=(type==="y")?num(price):num(price)*12;
      return {name, monthly, yearly, qty};
    }
  });
}
function readAddonRows(){
  return [...document.querySelectorAll(".addonRow")].map(r=>{
    const [type, price, name] = r.querySelector(".addonSel").value.split("|");
    const qty = num(r.querySelector(".qtySel").value);
    if(type==="o"){ return {name, once:num(price), qty}; }
    if(type==="m"){ const m=num(price); return {name, monthly:m, yearly:m*12, qty}; }
    const y=num(price); return {name, monthly:Math.round(y/12), yearly:y, qty};
  });
}
function readDeviceRows(){
  return [...document.querySelectorAll(".deviceRow")].map(r=>{
    const [_, price, name] = r.querySelector(".deviceSel").value.split("|");
    const qty = num(r.querySelector(".qtySel").value);
    return {name, once:num(price), qty};
  });
}

function rebuildPdfTable(){
  const tb=$("#pdf_like tbody"); tb.innerHTML=""; let subtotal=0;

  const setup=readSetup();
  if(setup){
    subtotal+=setup.price;
    tb.insertAdjacentHTML("beforeend", `<tr>
      <td>${setup.name}</td><td class="num">${fmt(setup.price)} å…ƒ</td><td class="num"></td>
      <td class="num"></td><td class="num">1</td><td class="num">${fmt(setup.price)} å…ƒ</td></tr>`);
  }

  const clouds=readCloudRows();
  clouds.forEach(c=>{
    const sub=c.yearly*c.qty; subtotal+=sub;
    tb.insertAdjacentHTML("beforeend", `<tr>
      <td>${c.name}</td><td class="num"></td><td class="num">${fmt(c.monthly)}</td>
      <td class="num">${fmt(c.yearly)}</td><td class="num">${c.qty}</td><td class="num">${fmt(sub)} å…ƒ/å¹´</td></tr>`);
  });

  const sp=readSpaceTier();
  if(sp){
    const sub=sp.yearly*sp.qty; subtotal+=sub;
    tb.insertAdjacentHTML("beforeend", `<tr>
      <td>${sp.name}</td><td class="num"></td><td class="num">${fmt(sp.monthly)}</td>
      <td class="num">${fmt(sp.yearly)}</td><td class="num">${sp.qty}</td><td class="num">${fmt(sub)} å…ƒ/å¹´</td></tr>`);
  }

  const addons=readAddonRows();
  addons.forEach(a=>{
    if(a.once!=null){
      const sub=a.once*a.qty; subtotal+=sub;
      tb.insertAdjacentHTML("beforeend", `<tr>
        <td>${a.name}</td><td class="num">${fmt(a.once)} å…ƒ</td><td class="num"></td>
        <td class="num"></td><td class="num">${a.qty}</td><td class="num">${fmt(sub)} å…ƒ</td></tr>`);
    }else{
      const sub=a.yearly*a.qty; subtotal+=sub;
      tb.insertAdjacentHTML("beforeend", `<tr>
        <td>${a.name}</td><td class="num"></td><td class="num">${fmt(a.monthly)}</td>
        <td class="num">${fmt(a.yearly)}</td><td class="num">${a.qty}</td><td class="num">${fmt(sub)} å…ƒ/å¹´</td></tr>`);
    }
  });

  const devices=readDeviceRows();
  devices.forEach(d=>{
    const sub=d.once*d.qty; subtotal+=sub;
    tb.insertAdjacentHTML("beforeend", `<tr>
      <td>${d.name}</td><td class="num">${fmt(d.once)} å…ƒ</td><td class="num"></td>
      <td class="num"></td><td class="num">${d.qty}</td><td class="num">${fmt(sub)} å…ƒ</td></tr>`);
  });

  // SSL last row
  const sslSel=document.getElementById("ssl_qty");
  if(sslSel){
    const sslQty = num(sslSel.value)||1, sslYearly=2000, sslSub=sslQty*sslYearly; subtotal+=sslSub;
    tb.insertAdjacentHTML("beforeend", `<tr>
      <td>SSL å¹´è²»</td><td class="num"></td><td class="num">${fmt(Math.round(sslYearly/12))}</td>
      <td class="num">${fmt(sslYearly)}</td><td class="num">${sslQty}</td><td class="num">${fmt(sslSub)} å…ƒ/å¹´</td></tr>`);
  }

  // Totals
  $("#pdf_sum").textContent = fmt(subtotal);
  const tax=Math.round(subtotal*0.05), total=subtotal+tax;
  $("#sum_ex").textContent = fmt(subtotal);
  $("#tax").textContent = fmt(tax);
  $("#total_inc").textContent = fmt(total);
  $("#sticky_total").textContent = fmt(total);
}

function calc(){ rebuildPdfTable(); }

function exportJson(){
  const rows=document.querySelectorAll("#pdf_like tbody tr");
  const pdfRows=[]; rows.forEach(tr=>{
    const tds=tr.querySelectorAll("td");
    pdfRows.push({ item:tds[0].textContent.trim(), once:tds[1].textContent.trim(), price_m:tds[2].textContent.trim(),
      price_y:tds[3].textContent.trim(), sets:tds[4].textContent.trim(), total:tds[5].textContent.trim() });
  });
  const payload={
    quote:{ date:$("#quote_date_view").value, contact:$("#contact_person").value },
    company:{
      name:$("#corp_name").value, tax:$("#corp_tax").value, tel:$("#corp_tel").value, email:$("#corp_email").value,
      addr:$("#corp_addr").value, site:$("#corp_site").value, logo:$("#logo_preview").src
    },
    pay_method: $("#pay_method").value,
    space_tier: (document.getElementById("space_tier")?.selectedOptions[0]?.textContent)||"",
    ssl_qty: Number((document.getElementById("ssl_qty")?.value)||1),
    table: pdfRows,
    subtotal_ex_tax: $("#sum_ex").textContent, tax_5pct: $("#tax").textContent, total_incl_tax: $("#total_inc").textContent,
    generated_at: new Date().toISOString()
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download=`MECANGO_æ­£å¼å ±åƒ¹_v5_7_${(new Date()).toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
}

function enableExcelMode(){
  document.body.classList.add("excel-mode");
  // æ›´æ–° Excel header æ¬„ä½
  headerPreview();
  window.print();
  // åˆ—å°å®Œå›åˆ°ä¸€èˆ¬æ¨¡å¼
  setTimeout(()=>document.body.classList.remove("excel-mode"), 1000);
}

document.addEventListener("DOMContentLoaded", ()=>{
  initQuoteDate();
  addCloudRow(); // initial row defaults to è£‚è®Šç‰ˆ
  document.getElementById("pay_method").addEventListener("change", ()=>{ document.getElementById("pay_view").textContent = document.getElementById("pay_method").value; });
  document.getElementById("pay_view").textContent = document.getElementById("pay_method").value;
  ["ssl_qty","space_tier","setup_enable","setup_choice"].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener("change", calc); }});
  document.addEventListener("input",(e)=>{ if(e.target && (e.target.classList.contains("manualPrice")||e.target.classList.contains("qtySel"))) calc(); });
  headerPreview();
  calc();
});
</script>
</body>
</html>
