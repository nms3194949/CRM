<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MECANGOï½œæ‹“å®¢CRM/POS/é›»å•† æ­£å¼å ±åƒ¹å–®ï¼ˆv5.5ï¼‰</title>
<style>
:root{
  --deep:#0A1221; --gold:#C9A227; --gold-soft:#E9D18A;
  --card:#0C152A; --ink:#e7ecf3; --muted:#9aa4b2; --line:rgba(233,209,138,.28);
  --accent:#1f2b4a; --ink-2:#cfd6e3;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--deep);color:var(--ink);font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif;line-height:1.5}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#0C152A,#0A1221)}
.brand{display:flex;gap:12px;align-items:center}
.brand img{width:56px;height:56px;object-fit:contain;border-radius:12px;border:1px solid var(--line);background:#0b1430}
.brand .meta{display:grid;gap:4px}
.brand .meta .corp{font-weight:800;font-size:18px;letter-spacing:.5px}
.brand .meta .sub{font-size:12px;color:var(--ink-2)}
.block{border:1px solid var(--line);border-radius:14px;padding:12px;background:var(--card);margin-top:12px}
.h{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.h .t{font-weight:800}
.h .t em{font-style:normal;color:var(--gold-soft)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
.row{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
.row label{color:var(--muted);font-size:14px}
.row input,.row select,.row textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--line);background:#071226;color:var(--ink);font-size:15px}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--line);background:transparent;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-size:15px}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold)}
.flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.line{border-top:1px dashed var(--line);margin:10px 0}
.rm{cursor:pointer;border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#0a152a}

.summary{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.summary table{width:100%;border-collapse:collapse}
.summary th,.summary td{padding:12px;border-bottom:1px solid var(--line)}
.summary thead th{background:#0e1830}
.summary .num{text-align:right;white-space:nowrap}
.summary tfoot td{font-weight:700}

.totalgrid{display:grid;grid-template-columns:1fr 300px;gap:12px;align-items:flex-start}
.totalbox{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1630}
.totalbox .row2{display:flex;justify-content:space-between;margin:6px 0}
.totalbox .row2 strong{font-size:18px}
.termblock{border:1px dashed var(--line);border-radius:12px;padding:10px}
.legal{margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#0a162f;white-space:pre-wrap;line-height:1.7}

.stickybar{position:sticky;bottom:8px;left:0;right:0;margin-top:12px;display:flex;gap:8px;justify-content:space-between;align-items:center;background:rgba(12,21,42,.9);backdrop-filter:blur(6px);border:1px solid var(--line);border-radius:12px;padding:8px 12px}
.stickybar .fig{font-weight:800;font-size:18px}

@media print{
  .stickybar,.btns{display:none}
  .wrap{max-width:100%;padding:0}
  .header,.block{page-break-inside:avoid}
  .legal{max-height:none;overflow:visible}
}
</style>
</head>
<body>
<div class="wrap">

  <!-- é é¦– -->
  <div class="header">
    <div class="brand">
      <img id="logo_preview" src="https://crmpos.mecango.com/_files/49/9040149/f/eae0f725de036939.png" alt="Logo" />
      <div class="meta">
        <div class="corp" id="corp_name_view">ï¼ˆå…¬å¸æŠ¬é ­ï¼‰</div>
        <div class="sub" id="corp_sub_view">çµ±ç·¨ï¼š90693783ï½œåœ°å€ï¼šé«˜é›„å¸‚å·¦ç‡Ÿå€å­Ÿå­è·¯37è™Ÿ3æ¨“</div>
      </div>
    </div>
    <div class="btns">
      <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°/å­˜ PDF</button>
      <button class="btn" onclick="exportJson()">â¬‡ï¸ åŒ¯å‡º JSON</button>
    </div>
  </div>

  <!-- å ±åƒ¹å–®è³‡è¨Š -->
  <div class="block">
    <div class="h"><div class="t">å ±åƒ¹å–®è³‡è¨Š <em>Quote Info</em></div><span class="badge">åˆè¨ˆé¡¯ç¤ºå«ç¨…5%</span></div>
    <div class="grid2">
      <div class="row"><label>å ±åƒ¹æ—¥æœŸ</label><input id="quote_date_view" type="date"></div>
      <div class="row"><label>å…¬å¸æŠ¬é ­</label><input id="corp_name" placeholder=""></div>
      <div class="row"><label>è¯çµ¡äºº</label><input id="contact_person" placeholder=""></div>
      <div class="row"><label>çµ±ä¸€ç·¨è™Ÿ</label><input id="corp_tax" placeholder="" inputmode="numeric"></div>
      <div class="row"><label>é›»è©±</label><input id="corp_tel" placeholder="" inputmode="tel"></div>
      <div class="row"><label>Email</label><input id="corp_email" placeholder="" inputmode="email"></div>
      <div class="row"><label>å…¬å¸åœ°å€</label><input id="corp_addr" placeholder=""></div>
      <div class="row"><label>å®˜ç¶²</label><input id="corp_site" placeholder="" inputmode="url"></div>
      <div class="row"><label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="pay_method">
          <option>åŒ¯æ¬¾</option><option>ç¾é‡‘</option><option>åˆ·å¡(5%)</option><option>ç„¡å¡åˆ†æœŸ(5%)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ç³»çµ±å¹³å° -->
  <div class="block">
    <div class="h"><div class="t">ç³»çµ±å¹³å° <em>Platform</em></div><span class="badge2">ä¸€æ¬¡æ€§ï¼‹å¹´è²»</span></div>
    <div class="flex">
      <label class="flex"><input type="checkbox" id="setup_enable" style="width:22px;height:22px" checked> <span style="margin-left:8px">ç³»çµ±å»ºç½®è²»</span></label>
      <select id="setup_choice" style="min-width:260px">
        <option value="CRM å»ºç½®è²»|15000">CRM å»ºç½®è²»ï¼ˆ15,000 å…ƒï¼‰</option>
        <option value="é¤é£²POS å»ºç½®è²»|18000">é¤é£²POS å»ºç½®è²»ï¼ˆ18,000 å…ƒï¼‰</option>
        <option value="ç¾æ¥­POS å»ºç½®è²»|20000">ç¾æ¥­POS å»ºç½®è²»ï¼ˆ20,000 å…ƒï¼‰</option>
        <option value="CRM é›»å•†å»ºç½®|25000">CRM é›»å•†å»ºç½®ï¼ˆ25,000 å…ƒï¼‰</option>
        <option value="å½±éŸ³é–‹èª²å»ºç½®è²»|35000">å½±éŸ³é–‹èª²å»ºç½®è²»ï¼ˆ35,000 å…ƒï¼‰</option>
      </select>

      <span>ç©ºé–“/äººæ•¸</span>
      <select id="space_tier" style="min-width:260px">
        <option value="0|50G/10,000äºº $0/æœˆ">50G/10,000äºº $0/æœˆ</option>
        <option value="500|100G/2è¬äºº +$500/æœˆ">100G/2è¬äºº +$500/æœˆ</option>
        <option value="1000|100G/5è¬äºº +$1,000/æœˆ">100G/5è¬äºº +$1,000/æœˆ</option>
        <option value="1500|200G/10è¬äºº +$1,500/æœˆ">200G/10è¬äºº +$1,500/æœˆ</option>
      </select>
    </div>

    <div class="flex" style="margin-top:6px">
      <span>SSL çµ„æ•¸ï¼ˆ$2,000/å¹´ï¼‰</span>
      <select id="ssl_qty" style="min-width:120px"></select>
    </div>
  </div>

  <!-- é›²ç«¯è³‡æ–™åº« -->
  <div class="block">
    <div class="h"><div class="t">é›²ç«¯è³‡æ–™åº« <em>Cloud Database</em></div><span class="badge2">å¯æ–°å¢å¤šç­†</span></div>
    <div id="cloud_rows"></div>
    <div class="line"></div>
    <button class="btn" onclick="addCloudRow()">ï¼‹ æ–°å¢ä¸€ç­†é›²ç«¯è³‡æ–™åº«</button>
  </div>

  <!-- åŠ å€¼æœå‹™ -->
  <div class="block">
    <div class="h"><div class="t">åŠ å€¼æœå‹™ <em>Add-ons</em></div><span class="badge2">å¯æ–°å¢å¤šç­†</span></div>
    <div id="addon_rows"></div>
    <div class="line"></div>
    <button class="btn" onclick="addAddonRow()">ï¼‹ æ–°å¢åŠ å€¼æœå‹™</button>
  </div>

  <!-- è¨­å‚™ -->
  <div class="block">
    <div class="h"><div class="t">è¨­å‚™ <em>Hardware</em></div><span class="badge2">å¯æ–°å¢å¤šç­†</span></div>
    <div id="device_rows"></div>
    <div class="line"></div>
    <button class="btn" onclick="addDeviceRow()">ï¼‹ æ–°å¢è¨­å‚™</button>
  </div>

  <!-- è¨‚è³¼å…§å®¹èªªæ˜ -->
  <div class="block summary">
    <div class="h"><div class="t">è¨‚è³¼å…§å®¹èªªæ˜ <em>Order Summary</em></div></div>
    <table id="pdf_like">
      <thead>
        <tr>
          <th>é …ç›®</th>
          <th class="num">å–®æ¬¡</th>
          <th class="num">å–®åƒ¹(æœˆ)</th>
          <th class="num">å–®åƒ¹(å¹´)</th>
          <th class="num">å¥—æ•¸</th>
          <th class="num">ç¸½é‡‘é¡</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="5" class="num">å°è¨ˆï¼ˆæœªç¨…ï¼‰</td><td class="num" id="pdf_sum">0</td></tr>
      </tfoot>
    </table>
  </div>

  <!-- å‚™è¨» / åˆè¨ˆ / åŒ¯æ¬¾è³‡è¨Š / æ³¨æ„äº‹é … -->
  <div class="totalgrid">
    <div class="block termblock">
      <div class="h"><div class="t">å‚™è¨»èˆ‡æ¢æ¬¾ <em>Terms</em></div></div>
      <ul style="margin:0 0 6px 18px">
        <li>åƒ¹æ ¼å‡ç‚ºæœªç¨…ï¼Œåˆè¨ˆé¡¯ç¤ºå«ç¨… 5%ã€‚</li>
        <li>å ±åƒ¹æœ‰æ•ˆæœŸé™ç‚º30å¤©ï¼Œé€¾æœŸè«‹é‡æ–°è©¢åƒ¹ã€‚</li>
        <li>å¦‚ä½¿ç”¨åˆ·å¡/ç„¡å¡åˆ†æœŸï¼Œå°‡å¦åŠ æ‰‹çºŒè²»ã€‚</li>
      </ul>

      <div class="legal" id="legal_text">â€» æœ¬ç”³è«‹å–®è¦–åŒåˆç´„æ›¸ã€‚â€»æœ¬ç”³è«‹æ›¸ä¸€å¼äºŒä»½ï¼Œç¢ºèªç°½ç« å¾Œï¼Œè²·è³£é›™æ–¹å„åŸ·ä¸€ä»½ã€‚
â€» æœ¬ç³»çµ±é›²ç«¯æœå‹™ç‚ºå¹´ç´„åˆ¶ï¼Œè‡ªé–‹é€šæ—¥èµ·ç®—è‡³å°‘ç‚ºæœŸ1å¹´ï¼Œ è²·è³£é›™æ–¹å®Œæˆæœ¬åˆç´„ç°½è¨‚ä¹‹åŒæ™‚,è²·æ–¹å‰‡è¦–åŒèªçŸ¥æœ¬æ¡è³¼ä¹‹å•†å“å®¢è£½åŒ–æœå‹™,è³£æ–¹ç„¡æ³•å°‡å•†å“è½‰å”®
   ç¬¬ä¸‰æ–¹,æ•…è²·æ–¹ç°½ç´„ä¸‰å¤©å¾Œä¸å¾—è¦æ±‚é€€æ¬¾ã€‚
â€» ç³»çµ±äº¤æ¥æ™‚ç”²æ–¹é ˆæ´¾é£è¬›å¸«å‘ç”²æ–¹ä»¥ç¾å ´æˆ–æ˜¯é ç«¯ç­‰æ•™å­¸æ–¹å¼æä¾›è‡³å°‘ä¸€å ´å…±è¨ˆ1å°æ™‚ä¹‹ç³»çµ±ç®¡ç†æ•™è‚²è¨“ç·´ã€‚é™¤ç·šä¸Šè«®è©¢å”®æœä¸åœ¨æ­¤é™ä¹‹å¤–ï¼Œå¦‚å¾ŒçºŒä¹™æ–¹æˆ–ä¹™
   æ–¹å®¢æˆ¶æå‡ºé¡å¤–çš„æ•™è‚²é †ç·´éœ€æ±‚ï¼Œå‰‡å¦éœ€æ”¯ä»˜ç”²æ–¹è¬›å¸«è²»$1,000/å°æ™‚ã€‚å¦‚æ•™å­¸åœ°é»åœ¨å¤–ç¸£å¸‚ï¼Œäº¤é€šä½å®¿è²»å¦è¨ˆï¼Œè«‹æ¬¾æ¡å¯¦å ±å¯¦éŠ·,å…¶é¤˜ç›¸é—œé–‹æ”¯ä¹™æ–¹ç„¡é ˆæ”¯ä»˜ã€‚
â€» é—œæ–¼å®˜æ–¹LINEæœ¬èº«çš„åŠŸèƒ½é™åˆ¶æˆ–åŠŸèƒ½è®Šæ›´ç­‰ç›¸é—œè¨­å®šèˆ‡æ“ä½œæŠ€è¡“å•é¡Œéæœ¬å…¬å¸æœå‹™çš„ç¯„åœå…§,åƒ…é™æœ¬å…¬å¸æä¾›ä¹‹CRM/POSç³»çµ±å”®æœã€‚
â€» æœ¬å¥‘ç´„ä»¥ä¸­è¯æ°‘åœ‹æ³•å¾‹ç‚ºæº–æ“šæ³•ï¼Œå¦‚æœ‰æœªç›¡äº‹å®œï¼Œä¾ç›¸é—œæ³•å¾‹è¦å®šï¼Œé›™æ–¹æ‡‰æœ¬èª ä¿¡åŸå‰‡å”å•†è§£æ±ºï¼Œå› æœ¬å¥‘ç´„æ‰€ç”Ÿä¹‹çˆ­è¨Ÿï¼Œé›™æ–¹åˆæ„ä»¥å°ç£é«˜é›„åœ°æ–¹æ³•é™¢ç‚ºç¬¬ä¸€
å¯©ç®¡è½„æ³•é™¢ã€‚</div>

      <div class="line"></div>
      <div>
        <div class="t" style="font-weight:700;margin:4px 0 6px 0">åŒ¯æ¬¾è³‡è¨Š</div>
        <div class="small">
          æˆ¶åï¼šå±¹ç™»è‚¡ä»½æœ‰é™å…¬å¸<br>
          éŠ€è¡Œï¼š807æ°¸è±éŠ€è¡ŒåŒ—é«˜é›„åˆ†è¡Œ<br>
          å¸³è™Ÿï¼š04201810038503
        </div>
      </div>
    </div>

    <div class="block totalbox">
      <div class="row2"><div>å°è¨ˆï¼ˆæœªç¨…ï¼‰</div><div id="sum_ex">0</div></div>
      <div class="row2"><div>ç¨…é¡ï¼ˆ5%ï¼‰</div><div id="tax">0</div></div>
      <div class="row2"><strong>åˆè¨ˆï¼ˆå«ç¨…ï¼‰</strong><strong id="total_inc">0</strong></div>
      <div class="small" style="margin-top:6px">ä»˜æ¬¾æ–¹å¼ï¼š<span id="pay_view">åŒ¯æ¬¾</span></div>
    </div>
  </div>

  <!-- Sticky åˆè¨ˆï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ -->
  <div class="stickybar">
    <div>åˆè¨ˆï¼ˆå«ç¨…ï¼‰</div>
    <div class="fig" id="sticky_total">0</div>
    <div class="btns">
      <button class="btn primary" onclick="window.print()">åˆ—å°/å­˜PDF</button>
    </div>
  </div>

</div>

<script>
const $ = (sel)=>document.querySelector(sel);
const fmt = (n)=> Number.isFinite(+n) ? (+n).toLocaleString('zh-TW') : n;
const num = (v)=> { const n = parseFloat(String(v).replace(/[^\d.-]/g,'')); return isNaN(n)?0:n; };

// Init quote date as today (user can change)
function initQuoteDate(){
  const d = new Date();
  const ds = d.toISOString().slice(0,10);
  const el = document.getElementById("quote_date_view");
  if(!el.value) el.value = ds;
}

// SSL select 1..20
(function initSSL(){
  const sel = document.getElementById('ssl_qty');
  sel.innerHTML = "";
  for(let i=1;i<=20;i++){
    const o=document.createElement('option');
    o.value=i; o.textContent=i; if(i===1) o.selected=true;
    sel.appendChild(o);
  }
})();

// Cloud options
const CLOUD_OPTIONS = [
  {name:"ç¸½åº—ç³»çµ±", yearly:60000},
  {name:"CRMå­ç¶²", manual:true},
  {name:"CRM(å–®åº—)ï¼å¾®åº—ç‰ˆ", monthly:3000},
  {name:"CRM(å–®åº—)ï¼å°ˆæ¥­ç‰ˆ", monthly:4000},
  {name:"CRM(å–®åº—)ï¼è£‚è®Šç‰ˆ", monthly:5000},
  {name:"CRM+POSï¼å°è³‡ç‰ˆ", monthly:3600},
  {name:"CRM+POSï¼æ”¤å•†ç‰ˆ", monthly:4600},
  {name:"CRM+POSï¼é–€åº—ç‰ˆ", monthly:5600},
  {name:"ç¾æ¥­é ç´„POSï¼å‰µæ¥­ç‰ˆ", monthly:3600},
  {name:"ç¾æ¥­é ç´„POSï¼å°ˆå®¶ç‰ˆ", monthly:4600},
  {name:"ç¾æ¥­é ç´„POSï¼ä¼æ¥­ç‰ˆ", monthly:5600},
  {name:"å½±éŸ³é–‹èª²(500G)", monthly:5500},
  {name:"é›»å•†å¹³å°", yearly:18000},
  {name:"æ´¾å·¥POS", yearly:12000},
];

const ADDON_OPTIONS = [
  {name:"è¨‚ä½/é ç´„ç³»çµ±", yearly:15000},
  {name:"å¤šå…ƒæ”¯ä»˜", yearly:5000},
  {name:"å¤šåº—æ ¸éŠ·", monthly:1000},
  {name:"é›»å­ç™¼ç¥¨(è—æ–°)", once:3500},
  {name:"æ¨è–¦é›†é»", yearly:5000},
  {name:"é¸å–®ä¿®æ”¹", once:3000},
];

const DEVICE_OPTIONS = [
  {name:"Wifi+USBå‡ºå–®æ©Ÿ(80mm)", once:5500, unit:"å°"},
  {name:"Wifi+USBå‡ºå–®æ©Ÿ(58mm)+ç™¼ç¥¨æ©Ÿ", once:8500, unit:"å°"},
  {name:"Wifi+USBæ¨™ç±¤è²¼ç´™æ©Ÿ", once:6500, unit:"å°"},
  {name:"å‡ºå–®ç´™(80*80)", once:1800},
  {name:"ç™¼ç¥¨ç´™", once:1980},
  {name:"æ¨™ç±¤ç´™(100å·)", once:27000},
  {name:"äºŒç¶­æ¢ç¢¼å™¨_ç„¡ç·šè—ç‰™", once:1800, unit:"æ”¯"},
  {name:"é›»å­éŒ¢æ«ƒ", once:1980, unit:"æ”¯"},
];

function cloudOptionsHTML(){
  return CLOUD_OPTIONS.map((o)=>{
    if(o.manual){
      return `<option value="man||${o.name}">${o.name}ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼æœˆï¼‰</option>`;
    }
    const label = o.monthly ? `${o.name}ï¼ˆ${o.monthly.toLocaleString('zh-TW')} å…ƒ/æœˆï¼‰` : `${o.name}ï¼ˆ${o.yearly.toLocaleString('zh-TW')} å…ƒ/å¹´ï¼‰`;
    const value = o.monthly ? `m|${o.monthly}|${o.name}` : `y|${o.yearly}|${o.name}`;
    return `<option value="${value}">${label}</option>`;
  }).join('');
}
function addonOptionsHTML(){
  return ADDON_OPTIONS.map(o=>{
    if(o.once){ return `<option value="o|${o.once}|${o.name}">${o.name}ï¼ˆ${o.once.toLocaleString('zh-TW')} å…ƒ/æ¬¡ï¼‰</option>`; }
    if(o.monthly){ return `<option value="m|${o.monthly}|${o.name}">${o.name}ï¼ˆ${o.monthly.toLocaleString('zh-TW')} å…ƒ/æœˆï¼‰</option>`; }
    return `<option value="y|${o.yearly}|${o.name}">${o.name}ï¼ˆ${o.yearly.toLocaleString('zh-TW')} å…ƒ/å¹´ï¼‰</option>`;
  }).join('');
}
function deviceOptionsHTML(){
  return DEVICE_OPTIONS.map(o=>`<option value="o|${o.once}|${o.name}">${o.name}ï¼ˆ${o.once.toLocaleString('zh-TW')} å…ƒ${o.unit?"/"+o.unit:""}ï¼‰</option>`).join('');
}

function qtySelectHTML(cls="qtySel",max=20,defaultVal=1){
  const opts = [];
  for(let i=1;i<=max;i++){ opts.push(`<option ${i===defaultVal?'selected':''}>${i}</option>`); }
  return `<select class="${cls}">${opts.join('')}</select>`;
}

function cloudRowHTML(){
  return `<div class="flex cloudRow" style="gap:10px;align-items:center;margin-bottom:8px">
    <select class="cloudSel" style="min-width:360px">${cloudOptionsHTML()}</select>
    <span class="manualBox">å–®åƒ¹(æœˆ)ï¼š<input class="manualPrice" type="number" inputmode="numeric" placeholder="è«‹è¼¸å…¥"> å…ƒ</span>
    <div>å¥—æ•¸ï¼š${qtySelectHTML("qtySel",20,1)}</div>
    <button class="rm" title="ç§»é™¤">ç§»é™¤</button>
  </div>`;
}
function addonRowHTML(){
  return `<div class="flex addonRow" style="gap:10px;align-items:center;margin-bottom:8px">
    <select class="addonSel" style="min-width:360px">${addonOptionsHTML()}</select>
    <div>å¥—æ•¸ï¼š${qtySelectHTML("qtySel",20,1)}</div>
    <button class="rm" title="ç§»é™¤">ç§»é™¤</button>
  </div>`;
}
function deviceRowHTML(){
  return `<div class="flex deviceRow" style="gap:10px;align-items:center;margin-bottom:8px">
    <select class="deviceSel" style="min-width:360px">${deviceOptionsHTML()}</select>
    <div>æ•¸é‡ï¼š${qtySelectHTML("qtySel",50,1)}</div>
    <button class="rm" title="ç§»é™¤">ç§»é™¤</button>
  </div>`;
}

function addCloudRow(){
  const c=document.getElementById("cloud_rows");
  c.insertAdjacentHTML("beforeend", cloudRowHTML());
  const row = c.lastElementChild;
  bindCloudEvents(row);
  // default to è£‚è®Šç‰ˆ
  const sel = row.querySelector(".cloudSel");
  const targetVal = "m|5000|CRM(å–®åº—)ï¼è£‚è®Šç‰ˆ";
  const opt = [...sel.options].find(o=>o.value===targetVal);
  if(opt){ sel.value = targetVal; }
  // trigger change to refresh manual box state
  sel.dispatchEvent(new Event('change'));
  calc();
}
function addAddonRow(){ const c=document.getElementById("addon_rows"); c.insertAdjacentHTML("beforeend", addonRowHTML()); bindAddonEvents(c.lastElementChild); calc(); }
function addDeviceRow(){ const c=document.getElementById("device_rows"); c.insertAdjacentHTML("beforeend", deviceRowHTML()); bindDeviceEvents(c.lastElementChild); calc(); }

function bindCloudEvents(row){
  const sel = row.querySelector(".cloudSel");
  const box = row.querySelector(".manualBox");
  const price = row.querySelector(".manualPrice");
  function toggleManual(){
    if(sel.value.startsWith("man|")){ box.style.display="inline-flex"; price.focus(); }
    else { box.style.display="none"; price.value=""; }
    calc();
  }
  sel.addEventListener("change", toggleManual);
  row.querySelector(".qtySel").addEventListener("change", calc);
  price.addEventListener("input", calc);
  row.querySelector(".rm").addEventListener("click", ()=>{ row.remove(); calc(); });
  toggleManual();
}
function bindAddonEvents(row){
  row.querySelector(".addonSel").addEventListener("change", calc);
  row.querySelector(".qtySel").addEventListener("change", calc);
  row.querySelector(".rm").addEventListener("click", ()=>{ row.remove(); calc(); });
}
function bindDeviceEvents(row){
  row.querySelector(".deviceSel").addEventListener("change", calc);
  row.querySelector(".qtySel").addEventListener("change", calc);
  row.querySelector(".rm").addEventListener("click", ()=>{ row.remove(); calc(); });
}

function headerPreview(){
  const name = $("#corp_name").value || "ï¼ˆå…¬å¸æŠ¬é ­ï¼‰";
  // sub (tax/address) is fixed text per request
  $("#corp_name_view").textContent = name;
}

["corp_name"].forEach(id=>{
  document.addEventListener("input",(e)=>{ if(e.target.id===id) headerPreview(); });
});

function readSetup(){
  const enabled = document.getElementById("setup_enable").checked;
  const choice = document.getElementById("setup_choice").value;
  const [name, price] = choice.split("|");
  return enabled ? {name, price: num(price)} : null;
}
function readSpaceTier(){
  const v = document.getElementById("space_tier").value; // "monthly|label"
  const [monthly, label] = v.split("|");
  const m = num(monthly);
  return {name:`é›²ç«¯ç©ºé–“/äººæ•¸æ–¹æ¡ˆï¼ˆ${label}ï¼‰`, monthly:m, yearly:m*12, qty:1, kind:"space"};
}
function readCloudRows(){
  const rows = [...document.querySelectorAll(".cloudRow")];
  return rows.map(r=>{
    const sel = r.querySelector(".cloudSel").value;
    const [type, price, name] = sel.split("|");
    const qty = num(r.querySelector(".qtySel").value);
    if(type==="man"){
      const pm = num(r.querySelector(".manualPrice").value||0);
      const yearly = pm*12;
      return {name, monthly: pm, yearly, qty, kind:"cloud"};
    }else{
      const monthly = (type==="m") ? num(price) : 0;
      const yearly = (type==="y") ? num(price) : (num(price)*12);
      return {name, monthly: (type==="m")?monthly:Math.round(yearly/12), yearly, qty, kind:"cloud"};
    }
  });
}
function readAddonRows(){
  const rows = [...document.querySelectorAll(".addonRow")];
  return rows.map(r=>{
    const sel = r.querySelector(".addonSel").value;
    const [type, price, name] = sel.split("|");
    const qty = num(r.querySelector(".qtySel").value);
    if(type==="o"){
      return {name, once: num(price), qty, kind:"addon"};
    }else if(type==="m"){
      const monthly = num(price), yearly = monthly*12;
      return {name, monthly, yearly, qty, kind:"addon"};
    }else{
      const yearly = num(price), monthly = Math.round(yearly/12);
      return {name, monthly, yearly, qty, kind:"addon"};
    }
  });
}
function readDeviceRows(){
  const rows = [...document.querySelectorAll(".deviceRow")];
  return rows.map(r=>{
    const sel = r.querySelector(".deviceSel").value;
    const [_, price, name] = sel.split("|");
    const qty = num(r.querySelector(".qtySel").value);
    return {name, once: num(price), qty, kind:"device"};
  });
}

function rebuildPdfTable(){
  const tb = document.querySelector("#pdf_like tbody");
  tb.innerHTML = "";
  let subtotal = 0;

  // Setup (once)
  const setup = readSetup();
  if(setup){
    const sub = setup.price; subtotal += sub;
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${setup.name}</td>
        <td class="num">${fmt(setup.price)} å…ƒ</td>
        <td class="num"></td>
        <td class="num"></td>
        <td class="num">1</td>
        <td class="num">${fmt(sub)} å…ƒ</td>
      </tr>
    `);
  }

  // Cloud rows
  const clouds = readCloudRows();
  clouds.forEach(c=>{
    const sub = c.yearly * c.qty; subtotal += sub;
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${c.name}</td>
        <td class="num"></td>
        <td class="num">${fmt(c.monthly)}</td>
        <td class="num">${fmt(c.yearly)}</td>
        <td class="num">${c.qty}</td>
        <td class="num">${fmt(sub)} å…ƒ/å¹´</td>
      </tr>
    `);
  });

  // Space tier row (before SSL)
  const sp = readSpaceTier();
  const spSub = sp.yearly * sp.qty;
  if(sp){
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${sp.name}</td>
        <td class="num"></td>
        <td class="num">${fmt(sp.monthly)}</td>
        <td class="num">${fmt(sp.yearly)}</td>
        <td class="num">${sp.qty}</td>
        <td class="num">${fmt(spSub)} å…ƒ/å¹´</td>
      </tr>
    `);
    subtotal += spSub;
  }

  // Add-on rows
  const addons = readAddonRows();
  addons.forEach(a=>{
    let sub = 0, monthly="", yearly="", once="";
    if(a.once!=null){
      sub = a.once * a.qty; subtotal += sub; once = `${fmt(a.once)} å…ƒ`;
    }else{
      sub = a.yearly * a.qty; subtotal += sub; monthly = fmt(a.monthly); yearly = fmt(a.yearly);
    }
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${a.name}</td>
        <td class="num">${once}</td>
        <td class="num">${monthly}</td>
        <td class="num">${yearly}</td>
        <td class="num">${a.qty}</td>
        <td class="num">${fmt(sub)} ${a.once!=null?"å…ƒ":"å…ƒ/å¹´"}</td>
      </tr>
    `);
  });

  // Device rows (once)
  const devices = readDeviceRows();
  devices.forEach(d=>{
    const sub = d.once * d.qty; subtotal += sub;
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${d.name}</td>
        <td class="num">${fmt(d.once)} å…ƒ</td>
        <td class="num"></td>
        <td class="num"></td>
        <td class="num">${d.qty}</td>
        <td class="num">${fmt(sub)} å…ƒ</td>
      </tr>
    `);
  });

  // SSL last row
  const sslQty = num(document.getElementById("ssl_qty").value)||1;
  const sslYearly = 2000;
  const sslSub = sslQty * sslYearly; subtotal += sslSub;
  tb.insertAdjacentHTML("beforeend", `
    <tr>
      <td>SSL å¹´è²»</td>
      <td class="num"></td>
      <td class="num">${fmt(Math.round(sslYearly/12))}</td>
      <td class="num">${fmt(sslYearly)}</td>
      <td class="num">${sslQty}</td>
      <td class="num">${fmt(sslSub)} å…ƒ/å¹´</td>
    </tr>
  `);

  // Totals
  document.getElementById("pdf_sum").textContent = fmt(subtotal);
  const tax = Math.round(subtotal * 0.05);
  const total = subtotal + tax;
  document.getElementById("sum_ex").textContent = fmt(subtotal);
  document.getElementById("tax").textContent = fmt(tax);
  document.getElementById("total_inc").textContent = fmt(total);
  document.getElementById("sticky_total").textContent = fmt(total);
}

function calc(){ rebuildPdfTable(); }

function exportJson(){
  const rows = document.querySelectorAll("#pdf_like tbody tr");
  const pdfRows = [];
  rows.forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    pdfRows.push({
      item: tds[0].textContent.trim(),
      once: tds[1].textContent.trim(),
      price_m: tds[2].textContent.trim(),
      price_y: tds[3].textContent.trim(),
      sets: tds[4].textContent.trim(),
      total: tds[5].textContent.trim(),
    });
  });
  const payload = {
    quote:{
      date: document.getElementById("quote_date_view").value,
      contact: document.getElementById("contact_person").value,
    },
    company:{
      name: $("#corp_name").value,
      tax: $("#corp_tax").value,
      tel: $("#corp_tel").value,
      email: $("#corp_email").value,
      addr: $("#corp_addr").value,
      site: $("#corp_site").value,
      logo: document.getElementById("logo_preview").src
    },
    pay_method: $("#pay_method").value,
    space_tier: document.getElementById("space_tier").selectedOptions[0].textContent,
    ssl_qty: Number($("#ssl_qty").value),
    table: pdfRows,
    subtotal_ex_tax: document.getElementById("sum_ex").textContent,
    tax_5pct: document.getElementById("tax").textContent,
    total_incl_tax: document.getElementById("total_inc").textContent,
    generated_at: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `MECANGO_æ­£å¼å ±åƒ¹_v5_5_${(new Date()).toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

document.addEventListener("DOMContentLoaded", ()=>{
  initQuoteDate();
  addCloudRow(); // initial row defaults to è£‚è®Šç‰ˆ
  document.getElementById("ssl_qty").addEventListener("change", calc);
  document.getElementById("space_tier").addEventListener("change", calc);
  document.getElementById("setup_enable").addEventListener("change", calc);
  document.getElementById("setup_choice").addEventListener("change", calc);
  document.getElementById("pay_method").addEventListener("change", ()=>{
    document.getElementById("pay_view").textContent = document.getElementById("pay_method").value;
  });
  document.getElementById("pay_view").textContent = document.getElementById("pay_method").value;
  headerPreview();
  calc();
});
</script>
</body>
</html>
